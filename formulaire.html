<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Accueil Chantier – Remplissage PDF (100% gratuit)</title>
    <style>
        /* Styles généraux pour l'ensemble du corps du document */
        :root { --brand:#0f172a; --accent:#0ea5e9; --muted:#e5e7eb; }
        * { box-sizing:border-box }
        html { height:100%; } /* S'assurer que html prend toute la hauteur */
        body{
            min-height:100vh; /* S'assurer que body prend au moins toute la hauteur du viewport */
            margin:0;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            color:var(--brand);
            /* Ajout du fond nid d'abeille ici */
            background: #fff url("assets/bg-honeycomb.png") center/340px repeat;
            padding:24px; /* Garder le padding autour de la carte */
            overflow-y: auto; /* Permettre le défilement vertical si le contenu dépasse */
            display: block; /* Assurer que body se comporte comme un bloc */
        }
        
        /* Styles de la carte principale qui contient le formulaire */
        .card{
            width:100%;
            max-width:900px;
            /* La carte doit être légèrement transparente pour voir l'arrière-plan */
            background: rgba(255,255,255,0.9); 
            backdrop-filter: saturate(120%) blur(2px); /* Effet de flou pour le fond */
            border:1px solid var(--muted);
            border-radius:16px;
            padding:24px;
            box-shadow:0 10px 30px rgba(2,8,23,.06);
            /* Min-height pour s'assurer qu'elle prend de la place, même avec peu de contenu */
            min-height: 200px; 
            margin: 0 auto; /* Centre la carte horizontalement */
        }
        
        /* Styles de l'en-tête de la carte (logo et titre) */
        header { 
            display: flex; 
            flex-direction: column; /* Empile les éléments (logo et div de texte) verticalement */
            align-items: center; /* Centre les éléments horizontalement dans l'en-tête */
            gap: 8px; /* Réduit l'espace entre le logo et le texte */
            margin-bottom: 12px; 
            text-align: center; /* Centre le texte à l'intérieur du div si nécessaire */
        }
        header img {
            /* Rendre le logo responsive */
            max-height: 40px; /* Hauteur maximale par défaut */
            max-width: 100%; /* S'assure que le logo ne dépasse pas la largeur du conteneur */
            height: auto; /* Maintient les proportions */
            width: auto; /* La largeur s'adapte automatiquement */
        }
        /* Media query pour les petits écrans (téléphones) */
        @media (max-width: 480px) {
            header img {
                max-height: 32px; /* Réduit la taille du logo sur les petits écrans */
            }
        }

        h1{font-size:clamp(20px,3.8vw,28px);margin:8px 0}
        
        /* Styles pour la disposition des éléments de formulaire en grille */
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
        
        /* Styles des étiquettes de formulaire */
        label{font-weight:600;font-size:14px}
        
        /* Styles des champs de saisie, textarea et select */
        input,textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
        
        /* Styles pour les lignes (par ex. pour les sélecteurs Oui/Non) */
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        
        /* Styles pour les groupes de cases à cocher */
        .checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}
        
        /* Styles pour les sections du formulaire */
        .section{border-top:1px solid var(--muted);margin-top:16px;padding-top:16px}
        
        /* Styles du conteneur des boutons d'action */
        .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
        
        /* Styles des boutons */
        button{appearance:none;border:1px solid #cbd5e1;background:#f8fafc;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer}
        button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
        button:active{transform:translateY(1px)}
        
        /* Styles pour le texte "muted" (petits messages d'information) */
        small.muted{display:block;margin-top:6px;color:#64748b}
        
        /* Styles pour les éléments alignés en ligne (par ex. label + select) */
        .inline{display:flex;align-items:center;gap:10px}

        /* Styles spécifiques pour la zone de signature */
        #signatureCanvas {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background-color: #f8fafc;
            touch-action: none; /* Empêche le défilement lors du dessin */
            /* Ajout d'un fond transparent pour la zone de dessin */
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), 
                              linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            position: relative; /* Pour positionner le texte d'instruction */
        }
        #signatureCanvas::after {
            content: "Dessinez votre signature ici";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 16px;
            pointer-events: none; /* Permet aux événements de souris de passer à travers */
        }
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <main class="card">
        <header>
            <img src="assets/logo-prdesjardins.png" alt="P+R Desjardins"/>
            <div>
                <h1>Accueil des travailleurs — Générateur PDF éditable</h1>
                <small class="muted">
                    Place le PDF modèle à <code>/assets/accueil_travailleurs.pdf</code> (ton original renommé).
                    Rien à payer, tout dans le navigateur.
                </small>
            </div>
        </header>

        <form id="form" onsubmit="return false;">
            <!-- Section Informations du projet -->
            <div class="grid">
                <div>
                    <label for="NomProjet">Nom du projet</label>
                    <input id="NomProjet" placeholder="Ex: Tour XYZ" />
                </div>
                <div>
                    <label for="NumProjet"># Projet</label>
                    <input id="NumProjet" placeholder="Ex: 12345" /> <!-- Placeholder modifié -->
                </div>
                <div>
                    <label for="MetierCCQ">Métier CCQ</label>
                    <input id="MetierCCQ" />
                </div>
                <div>
                    <label for="EcheanceCCQ">Échéance carte CCQ</label>
                    <input id="EcheanceCCQ" type="date" />
                </div>
                <div>
                    <label for="NomTravailleur">Prénom et Nom</label>
                    <input id="NomTravailleur" />
                </div>
                <div>
                    <label for="Entreprise">Entreprise</label>
                    <input id="Entreprise" />
                </div>
                <div>
                    <label for="Telephone">Téléphone (principal)</label> <!-- Libellé modifié -->
                    <input id="Telephone" type="tel" />
                </div>
                <div>
                    <label for="Telephone2">Téléphone (secondaire)</label> <!-- Libellé modifié -->
                    <input id="Telephone2" type="tel" />
                </div>
                <div>
                    <label for="Telephone3">Téléphone (contact d'urgence)</label> <!-- Libellé modifié -->
                    <input id="Telephone3" type="tel" />
                </div>
                <div>
                    <label for="ContactUrgence">Nom du contact d'urgence</label> <!-- Libellé modifié -->
                    <input id="ContactUrgence" />
                </div>
            </div>

            <!-- Section RSS et Problème de santé -->
            <div class="section">
                <div class="row">
                    <div class="inline">
                        <label for="Rss">Êtes‑vous intéressé à être RSS ?</label>
                        <select id="Rss"><option value="Non">Non</option><option value="Oui">Oui</option></select>
                    </div>
                    <div class="inline">
                        <label for="SantePb">Problème de santé ?</label>
                        <select id="SantePb"><option value="Non">Non</option><option value="Oui">Oui</option></select>
                    </div>
                </div>
                <label for="SanteDetails">Précisez (si Oui)</label>
                <textarea id="SanteDetails" rows="2" placeholder="Asthme, allergie, etc."></textarea>
            </div>

            <!-- Nouvelle Section : OBLIGATIONS EN TOUT TEMPS -->
            <div class="section">
                <h3>OBLIGATIONS EN TOUT TEMPS</h3>
                <p>
                    <strong>TRAVAUX EN COLLABORATION AVEC P+R</strong><br>
                    <strong>TOLÉRANCE ZÉRO</strong> En tout temps, les travaux doivent être exécutés de façon sécuritaire pour soi et pour tous les autres travailleurs présents sur le chantier, il est de la responsabilité de chacun de limiter au maximum les différents risques liés aux travaux. Poussière de silice cristalline - port d'appareil de protection respiratoire visage rasé OBLIGATOIRE, procédé humide ou captation à la source - Système de ventilation locale - isolation des postes de travail, Amiante suivre les recommandations selon le niveau de contamination, port des EPI équipements de protection individuels obligatoires, sécurité des machines, inspections obligatoires et s'assurer de la présence de dispositifs de sécurité.
                </p>
            </div>

            <!-- Section Formations du travailleur (réintégrée) -->
            <div class="section">
                <h3>FORMATIONS DU TRAVAILLEUR</h3>
                <div class="checkboxes">
                    <label><input type="checkbox" id="Cadenassage"> Cadenassage</label>
                    <label><input type="checkbox" id="Amiante"> Amiante / silice</label>
                    <label><input type="checkbox" id="EspaceClos"> Espace clos</label>
                    <label><input type="checkbox" id="Secourisme"> Secourisme en milieu de travail</label>
                    <label><input type="checkbox" id="Nacelle"> Nacelle</label>
                    <label><input type="checkbox" id="ProtectionRespiratoire"> Protection respiratoire (Fit Test 2 ans)</label>
                    <label><input type="checkbox" id="SIMDUT"> SIMDUT 2015 obligatoire</label>
                    <label><input type="checkbox" id="Plateforme"> Plateforme élévatrice</label>
                    <label><input type="checkbox" id="Autres"> Autres</label>
                </div>
            </div>

            <!-- Section Engagement du travailleur - MODIFIÉE -->
            <div class="section">
                <h3>ENGAGEMENT DU TRAVAILLEUR</h3>
                <p class="subtle" style="margin-bottom: 10px;">
                    Sur l'ensemble des chantiers, les règles de sécurité telles que décrites dans le Code de Santé et Sécurité pour les travaux de construction s'appliquent.
                </p>
                <p style="margin-bottom: 15px;">
                    Je m'engage à prendre connaissance du programme de prévention de l'entrepreneur général applicable au chantier, des tolérances zéro de la CNESST et je m'engage à les respecter. Notamment, je m'engage à n'entreprendre aucun travail pour lesquels j'ai constaté un risque pour ma sécurité ou celle d'une autre personne et d'aviser dès que possible mon supérieur immédiat de tout risque constaté. Je m'engage également à ne pas effectuer ou opérer de machinerie sans avoir préalablement avoir reçu la formation concernant les risques spécifiques. J'ai été informé de la gradation des mesures disciplinaires, des consignes à suivre lors d'un accident de travail avec ou sans perte de temps et j'ai fait la visite du chantier.
                </p>
                <!-- Nouveau paragraphe pour le texte de confirmation de la case à cocher -->
                <div class="inline" style="display: block; margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="Engagement" /> 
                        En cochant cette case, je confirme avoir lu l'entièreté du document et de mes engagements.
                    </label>
                </div>
            </div>

            <!-- Nouvelle Section : Bas du formulaire (Nom, Signature, Date) -->
            <div class="section">
                <div class="grid">
                    <div>
                        <label for="TravailleurNomFinal">Travailleur: (Prénom et Nom en lettres moulées)</label>
                        <input id="TravailleurNomFinal" type="text" />
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label>Signature</label>
                    <canvas id="signatureCanvas" width="400" height="100"></canvas>
                    <div class="signature-controls">
                        <button type="button" id="clearSignature">Effacer la signature</button>
                    </div>
                </div>
                
                <div class="grid" style="margin-top: 20px;">
                    <div>
                        <label for="DateFinale">Date</label>
                        <input id="DateFinale" type="date" />
                    </div>
                </div>
            </div>

            <!-- Boutons d'action pour le PDF -->
            <div class="btns">
                <button class="primary" id="btnGen">Générer le PDF (éditable)</button>
                <button id="btnGenFlatten">Générer (aplati pour impression)</button>
                <button id="btnPreview">Prévisualiser dans le navigateur</button>
                <button id="btnShare">Partager (mobile)</button>
            </div>
            <small class="muted">
                Astuce: ouvre la console F12 pour voir la liste exacte des noms de champs détectés dans le PDF (utile si certains noms varient).
            </small>
        </form>
    </main>

    <!-- Importation de la bibliothèque pdf-lib pour la manipulation de PDF -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // Utilitaires pour gérer les noms de champs PDF qui peuvent varier
        // Permet de trouver un champ par plusieurs noms possibles
        function getFieldByNames(form, names) {
            // S'assure que 'names' est toujours un tableau
            if (!Array.isArray(names)) {
                console.error("getFieldByNames: 'names' n'est pas un tableau.", names);
                return null;
            }
            for (const n of names) {
                try { return form.getField(n); } catch(e) {}
            }
            return null; // Retourne null si aucun champ n'est trouvé avec les noms donnés
        }

        // Définit le texte d'un champ PDF
        function setText(form, names, value) {
            const f = getFieldByNames(form, names);
            if (f && f.setText) { f.setText(value ?? ''); } // Utilise la valeur ou une chaîne vide
        }

        // Coche ou décoche une case à cocher dans le PDF
        function setCheck(form, names, checked) {
            const f = getFieldByNames(form, names);
            if (!f) return; // Ne fait rien si le champ n'est pas trouvé
            try { checked ? f.check?.() : f.uncheck?.(); } catch(e) { /* Gère silencieusement les erreurs */ }
        }

        // Mapping des IDs des éléments HTML avec les noms des champs PDF
        // Cela permet de connecter facilement le formulaire HTML au PDF
        const map = {
            // En-tête du formulaire
            nomProjet: ["NomProjet","Nom du projet","Nom Projet"],
            numProjet: ["Num Projet","# Projet","NumProjet"], 
            metierCCQ: ["Métier CCQ","Metier CCQ"],
            echeanceCCQ: ["Échéance Carte CCQ","Echeance Carte CCQ","Échéance carte CCQ"],

            // Coordonnées du travailleur
            nomTravailleur: ["NomTravailleur"],
            entreprise: ["Entreprise"],
            tel1: ["Téléphone","Telephone"],
            tel2: ["Téléphone_2","Telephone_2"],
            tel3: ["Téléphone_3","Telephone_3"],
            contactUrgence: ["Contact durgence"],

            // Choix Oui/Non (stockés en texte dans le PDF original)
            rss: ["Rss"],
            sante_pb: ["sante_pb"],
            sante_details: ["Santé_es_:sender:", "SANTÉ", "Sante_details", "Santé - précisez"],

            // Formations (cases à cocher)
            Cadenassage: ["Cadenassage"],
            Amiante: ["Amiante","Amiante /silice","Amiante / silice"],
            EspaceClos: ["Espace clos"],
            Secourisme: ["Secourisme en milieu de travail"],
            Nacelle: ["Nacelle"],
            ProtectionRespiratoire: ["Protection respiratoire","Protection respiratoire   Fit Test 2ans"],
            SIMDUT: ["SIMDUT 2015 obligatoire","SIMDUT"],
            Plateforme: ["Plateforme élévatrice"],
            Autres: ["Autres"],

            // Sujets traités (RETIRE du formulaire HTML, mais peut exister dans le PDF)
            RisquesGeneraux: ["Risque généraux","Risques généraux"],
            RisquesSpecifiques: ["Risques spécifique","Risques spécifiques au chantier"],
            Evacuation: ["Procédure d'évacuation","Procédure d'évacuation / Rassemblement"],
            Accident: ["Procédure en cas d'accident","Prodécure en cas d'accident (trousses, déclaration événement accidentel, formulaire assignation temporaire)"],
            Politiques: ["Politiques drogues et alcools","Politiques alcool, drogues, harcèlement et violence"],
            ToleranceZero: ["Tolérence zéro","Tolérances Zéro","Tolérance Zéro"],
            DroitsObligations: ["Droits et obligations"],
            EPI: ["EPI"],

            // Engagement du travailleur (case à cocher)
            Engagement: ["Case à cocher24"],

            // Nouveaux champs pour le bas du formulaire (Travailleur Nom Final, Date Finale)
            // Signature ne sera PAS un champ de formulaire PDF mais une image ajoutée.
            travailleurNomFinal: ["Travailleur Prénom et Nom en lettres moulées"], // Ajouté pour le champ de texte
            dateFinale: ["Date27_es_:signer:date", "Date"] // Ajouté pour la date du bas
            // RETIRÉ: signature: ["Signature26_es_:signer:signature:"] car ce n'est pas un champ de formulaire PDF.
        };

        // Charge le modèle PDF à partir de l'URL spécifiée
        async function loadTemplate() {
            const url = 'assets/accueil_travailleurs.pdf'; 
            const buf = await fetch(url).then(r => {
                if (!r.ok) throw new Error('PDF modèle introuvable à ' + url);
                return r.arrayBuffer();
            });
            return PDFLib.PDFDocument.load(buf);
        }

        // Lit les valeurs du formulaire HTML
        function readFormValues() {
            const $ = id => document.getElementById(id);
            const values = {
                nomProjet: $("NomProjet").value,
                numProjet: $("NumProjet").value,
                metierCCQ: $("MetierCCQ").value,
                echeanceCCQ: $("EcheanceCCQ").value,
                nomTravailleur: $("NomTravailleur").value,
                entreprise: $("Entreprise").value,
                tel1: $("Telephone").value,
                tel2: $("Telephone2").value,
                tel3: $("Telephone3").value,
                contactUrgence: $("ContactUrgence").value,
                rss: $("Rss").value === 'Oui',
                santePb: $("SantePb").value === 'Oui',
                santeDetails: $("SanteDetails").value,
                
                formations: {
                    Cadenassage: $("Cadenassage").checked,
                    Amiante: $("Amiante").checked,
                    EspaceClos: $("EspaceClos").checked,
                    Secourisme: $("Secourisme").checked,
                    Nacelle: $("Nacelle").checked,
                    ProtectionRespiratoire: $("ProtectionRespiratoire").checked,
                    SIMDUT: $("SIMDUT").checked,
                    Plateforme: $("Plateforme").checked,
                    Autres: $("Autres").checked,
                },
                
                engagement: $("Engagement").checked, // C'est cette valeur qui sera utilisée pour cocher/décocher

                // Nouveaux champs du bas de page
                travailleurNomFinal: $("TravailleurNomFinal").value,
                dateFinale: $("DateFinale").value,
                signatureData: getSignatureData(), // Récupère l'image de la signature
            };

            localStorage.setItem('lastTravailleurName', values.nomTravailleur);
            return values;
        }

        // Fonctions pour la signature sur canvas
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function resizeCanvas() {
            // S'assurer que le canvas prend toute la largeur disponible dans son parent
            canvas.width = canvas.offsetWidth;
            // Pour maintenir une hauteur raisonnable sur mobile, on peut la fixer ou la calculer
            canvas.height = 100; // Ou une valeur calculée si nécessaire
            ctx.fillStyle = "#f8fafc"; // Fond clair pour la signature
            ctx.fillRect(0, 0, canvas.width, canvas.height); // Remplir le fond
            ctx.strokeStyle = '#000'; // Couleur du trait
            ctx.lineWidth = 2; // Épaisseur du trait
            ctx.lineCap = 'round'; // Bords arrondis
        }

        // Redimensionne le canvas au chargement et lors du redimensionnement de la fenêtre
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mousemove', draw);
        // Support tactile
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Empêche le défilement
            startDrawing(e.touches[0]);
        });
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Empêche le défilement
            draw(e.touches[0]);
        });

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            const rect = canvas.getBoundingClientRect();
            // Utilise clientX/Y pour mousedown/mousemove et pageX/Y pour touch events
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.pageX) - rect.left;
            const y = (e.clientY || e.pageY) - rect.top;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            drawing = false;
        }

        document.getElementById('clearSignature').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#f8fafc"; // Réapplique le fond clair après effacement
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        // Fonction pour récupérer les données de la signature (image)
        function getSignatureData() {
            // Vérifie si le canvas a été dessiné (non vide)
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let hasContent = false;
            // Itérer sur les pixels pour voir s'il y a des pixels non-blancs/transparent
            for (let i = 0; i < imageData.data.length; i += 4) {
                // Vérifier si le pixel n'est pas complètement transparent (alpha > 0)
                // et n'est pas la couleur de fond #f8fafc (248, 250, 252)
                if (imageData.data[i + 3] > 0 && 
                   !(imageData.data[i] === 248 && imageData.data[i+1] === 250 && imageData.data[i+2] === 252)) {
                    hasContent = true;
                    break;
                }
            }
            if (hasContent) {
                return canvas.toDataURL('image/png');
            }
            return null; // Retourne null si le canvas est vide (ou seulement le fond)
        }

        // Pré-remplir la date du jour pour "DateFinale"
        window.addEventListener('load', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('DateFinale').value = `${year}-${month}-${day}`;
            resizeCanvas(); // Assure que le canvas est bien dimensionné au chargement

            // Tente de pré-remplir le nom du travailleur si sauvegardé
            const lastTravailleurName = localStorage.getItem('lastTravailleurName');
            if (lastTravailleurName) {
                document.getElementById('NomTravailleur').value = lastTravailleurName;
                document.getElementById('TravailleurNomFinal').value = lastTravailleurName;
            }
        });


        // Fonction principale pour construire le PDF
        async function buildPdf({ flatten = false, preview = false, share = false } = {}) {
            const v = readFormValues(); // Récupère les valeurs du formulaire HTML

            // Vérifie si la signature a été dessinée
            if (!v.signatureData) {
                alert("Veuillez dessiner votre signature avant de générer le PDF.");
                return; // Arrête la fonction si pas de signature
            }

            const pdf = await loadTemplate(); // Charge le PDF modèle
            const form = pdf.getForm(); // Accède aux champs du formulaire PDF
            const pages = pdf.getPages(); // Accède aux pages du PDF

            // Debug : Affiche la liste des noms de champs détectés dans le PDF (pour débugger le mapping)
            try {
                console.log('Champs détectés dans le PDF →');
                for (const f of form.getFields()) {
                    console.log('-', f.getName());
                }
            } catch(e) {
                console.error("Erreur lors de la lecture des champs PDF:", e);
            }

            // Remplissage des champs de texte
            setText(form, map.nomProjet, v.nomProjet);
            setText(form, map.numProjet, v.numProjet); 
            setText(form, map.metierCCQ, v.metierCCQ);
            
            // Conversion de la date (YYYY-MM-DD en DD/MM/YYYY)
            const d = v.echeanceCCQ ? new Date(v.echeanceCCQ) : null;
            const dStr = d ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` : '';
            setText(form, map.echeanceCCQ, dStr);

            setText(form, map.nomTravailleur, v.nomTravailleur);
            setText(form, map.entreprise, v.entreprise);
            setText(form, map.tel1, v.tel1);
            setText(form, map.tel2, v.tel2);
            setText(form, map.tel3, v.tel3);
            setText(form, map.contactUrgence, v.contactUrgence);

            // Remplissage des sélecteurs Oui/Non (qui sont des champs de texte dans le PDF)
            setText(form, map.rss, v.rss ? 'Oui' : 'Non');
            setText(form, map.sante_pb, v.santePb ? 'Oui' : 'Non');
            setText(form, map.sante_details, v.santeDetails);

            // Remplissage des cases à cocher pour les formations
            for (const key of Object.keys(v.formations)) {
                setCheck(form, map[key] || [key], !!v.formations[key]);
            }
            
            // Remplissage de la case à cocher d'engagement
            setCheck(form, map.Engagement, v.engagement);

            setText(form, map.travailleurNomFinal, v.travailleurNomFinal);
            
            // Remplissage des dates de signature (avec la date du jour)
            const today = new Date();
            const todayStr = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
            setText(form, map.date1, todayStr); 
            setText(form, map.date2, todayStr);
            setText(form, map.dateFinale, todayStr); // Remplit la date en bas du PDF

            // GESTION DE LA SIGNATURE DESSINÉE
            try {
                const signatureImage = await pdf.embedPng(v.signatureData);
                const lastPage = pages[pages.length - 1]; 
                
                // **** TRÈS IMPORTANT : AJUSTER CES COORDONNÉES ****
                // Pour trouver les coordonnées exactes (x, y) et la taille (width, height)
                // de votre champ de signature dans le PDF original :
                // 1. Ouvrez votre PDF dans Adobe Acrobat Pro.
                // 2. Allez dans Outils > Préparer le formulaire.
                // 3. Sélectionnez le champ de signature souhaité.
                // 4. Dans le panneau de droite (Propriétés du champ),
                //    vous trouverez les valeurs X, Y, Largeur et Hauteur.
                // Le système de coordonnées de pdf-lib commence en bas à gauche de la page.
                // Si votre PDF a des marges ou est plus complexe, il faudra tester et ajuster.
                // Exemple : si votre champ a Y = 50mm du haut et hauteur 20mm,
                // alors sa position Y dans pdf-lib serait `lastPage.getHeight() - 50 - 20`.
                const signatureX = 90 * 2.835;  // Position X en mm (à partir du bord gauche du PDF)
                const signatureY = 38 * 2.835; // Position Y en mm (à partir du bord bas du PDF)
                const signatureWidth = 55; // Largeur de l'image de signature en mm
                const signatureHeight = signatureImage.height * signatureWidth / signatureImage.width; // Maintient les proportions

                lastPage.drawImage(signatureImage, {
                    x: signatureX,
                    y: signatureY, 
                    width: signatureWidth,
                    height: signatureHeight,
                });
            } catch (error) {
                console.error("Erreur lors de l'intégration de la signature :", error);
                alert("La signature n'a pas pu être intégrée au PDF. Veuillez réessayer ou contacter l'administrateur.");
            }

            // Si "flatten" est vrai, les champs du formulaire sont fusionnés avec le document
            if (flatten) form.flatten();

            const bytes = await pdf.save(); // Sauvegarde le PDF modifié
            const filename = `Formulaire_PRD_${v.nomTravailleur.replace(/\s+/g, '_') || 'sans_nom'}_${Date.now()}.pdf`;
            const file = new File([bytes], filename, { type:'application/pdf' });

            // Stockage local pour la page d'accueil (optionnel si non utilisé)
            localStorage.setItem('generatedPdf', URL.createObjectURL(file)); 
            localStorage.setItem('generatedPdfFileName', filename); 

            // Messages de confirmation basés sur l'action
            let confirmationMessage = '';
            if (share && navigator.canShare?.({ files:[file] })) {
                try { 
                    await navigator.share({ files:[file], title:'Formulaire PRD', text:'Voici votre formulaire PRD rempli.' }); 
                    confirmationMessage = 'PDF généré et partagé !';
                } catch(e) { 
                    console.error("Erreur de partage:", e);
                    confirmationMessage = 'Partage annulé ou erreur de partage.';
                }
            }
            else if (preview) {
                const url = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
                window.open(url, '_blank');
                confirmationMessage = 'PDF généré et ouvert en prévisualisation !';
            }
            else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
                a.download = file.name;
                document.body.appendChild(a); 
                a.click(); 
                a.remove();
                confirmationMessage = 'PDF généré et téléchargé !';
            }
            
            // Affiche le message de confirmation
            alert(confirmationMessage);
        }

        // Événements des boutons
        document.getElementById('btnGen').addEventListener('click', () => buildPdf({ flatten:false }));
        document.getElementById('btnGenFlatten').addEventListener('click', () => buildPdf({ flatten:true }));
        document.getElementById('btnPreview').addEventListener('click', () => buildPdf({ preview:true }));
        document.getElementById('btnShare').addEventListener('click', () => buildPdf({ share:true }));
    </script>
</body>
</html>
