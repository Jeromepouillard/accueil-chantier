<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accueil Chantier – Remplissage PDF (100% gratuit)</title>
  <style>
    :root { --brand:#0f172a; --accent:#0ea5e9; --muted:#e5e7eb; }
    * { box-sizing:border-box }
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;display:flex;align-items:center;justify-content:center;padding:24px;color:var(--brand)}
    .card{width:100%;max-width:900px;background:#fff;border:1px solid var(--muted);border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(2,8,23,.06)}
    header{display:flex;gap:16px;align-items:center;margin-bottom:12px}
    header img{height:40px}
    h1{font-size:clamp(20px,3.8vw,28px);margin:8px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    label{font-weight:600;font-size:14px}
    input,textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}
    .section{border-top:1px solid var(--muted);margin-top:16px;padding-top:16px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
    button{appearance:none;border:1px solid #cbd5e1;background:#f8fafc;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    button:active{transform:translateY(1px)}
    small.muted{display:block;margin-top:6px;color:#64748b}
    .inline{display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <main class="card">
    <header>
      <img src="assets/logo-prdesjardins.png" alt="P+R Desjardins"/>
      <div>
        <h1>Accueil des travailleurs — Générateur PDF éditable</h1>
        <small class="muted">Place le PDF modèle à <code>/assets/accueil_travailleurs.pdf</code> (ton original renommé). Rien à payer, tout dans le navigateur.</small>
      </div>
    </header>

    <form id="form" onsubmit="return false;">
      <div class="grid">
        <div>
          <label>Nom du projet</label>
          <input id="NomProjet" placeholder="Ex: Tour XYZ" />
        </div>
        <div>
          <label># Projet</label>
          <input id="NumProjet" placeholder="# ACCUEIL" />
        </div>
        <div>
          <label>Métier CCQ</label>
          <input id="MetierCCQ" />
        </div>
        <div>
          <label>Échéance carte CCQ</label>
          <input id="EcheanceCCQ" type="date" />
        </div>
        <div>
          <label>Prénom et Nom</label>
          <input id="NomTravailleur" />
        </div>
        <div>
          <label>Entreprise</label>
          <input id="Entreprise" />
        </div>
        <div>
          <label>Téléphone</label>
          <input id="Telephone" type="tel" />
        </div>
        <div>
          <label>Téléphone 2</label>
          <input id="Telephone2" type="tel" />
        </div>
        <div>
          <label>Téléphone 3</label>
          <input id="Telephone3" type="tel" />
        </div>
        <div>
          <label>Contact d'urgence</label>
          <input id="ContactUrgence" />
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="inline">
            <label>Êtes‑vous intéressé à être RSS ?</label>
            <select id="Rss"><option value="Non">Non</option><option value="Oui">Oui</option></select>
          </div>
          <div class="inline">
            <label>Problème de santé ?</label>
            <select id="SantePb"><option value="Non">Non</option><option value="Oui">Oui</option></select>
          </div>
        </div>
        <label>Précisez (si Oui)</label>
        <textarea id="SanteDetails" rows="2" placeholder="Asthme, allergie, etc."></textarea>
      </div>

      <div class="section">
        <h3>FORMATIONS DU TRAVAILLEUR</h3>
        <div class="checkboxes">
          <label><input type="checkbox" id="Cadenassage"> Cadenassage</label>
          <label><input type="checkbox" id="Amiante"> Amiante / silice</label>
          <label><input type="checkbox" id="EspaceClos"> Espace clos</label>
          <label><input type="checkbox" id="Secourisme"> Secourisme en milieu de travail</label>
          <label><input type="checkbox" id="Nacelle"> Nacelle</label>
          <label><input type="checkbox" id="ProtectionRespiratoire"> Protection respiratoire (Fit Test 2 ans)</label>
          <label><input type="checkbox" id="SIMDUT"> SIMDUT 2015 obligatoire</label>
          <label><input type="checkbox" id="Plateforme"> Plateforme élévatrice</label>
          <label><input type="checkbox" id="Autres"> Autres</label>
        </div>
      </div>

      <div class="section">
        <h3>Sujets traités (accueil)</h3>
        <div class="checkboxes">
          <label><input type="checkbox" id="RisquesGeneraux"> Risques généraux</label>
          <label><input type="checkbox" id="RisquesSpecifiques"> Risques spécifiques au chantier</label>
          <label><input type="checkbox" id="Evacuation"> Procédure d'évacuation / Rassemblement</label>
          <label><input type="checkbox" id="Accident"> Procédure en cas d'accident</label>
          <label><input type="checkbox" id="Politiques"> Politiques alcool, drogues, harcèlement, violence</label>
          <label><input type="checkbox" id="ToleranceZero"> Tolérance zéro</label>
          <label><input type="checkbox" id="DroitsObligations"> Droits et obligations</label>
          <label><input type="checkbox" id="EPI"> EPI</label>
        </div>
      </div>

      <div class="section">
        <div class="inline">
          <input type="checkbox" id="Engagement" />
          <label for="Engagement">J'ai pris connaissance du programme de prévention, tolérances zéro, etc.</label>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnGen">Générer le PDF (éditable)</button>
        <button id="btnGenFlatten">Générer (aplati pour impression)</button>
        <button id="btnPreview">Prévisualiser dans le navigateur</button>
        <button id="btnShare">Partager (mobile)</button>
      </div>
      <small class="muted">Astuce: ouvre la console F12 pour voir la liste exacte des noms de champs détectés dans le PDF (utile si certains noms varient).</small>
    </form>
  </main>

  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
  // ===== Utilitaires tolérants (les champs PDF ont parfois des noms chelous) =====
  function getFieldByNames(form, names) {
    for (const n of names) {
      try { return form.getField(n); } catch(e) {}
    }
    return null;
  }
  function setText(form, names, value) {
    const f = getFieldByNames(form, names);
    if (f && f.setText) { f.setText(value ?? ''); }
  }
  function setCheck(form, names, checked) {
    const f = getFieldByNames(form, names);
    if (!f) return;
    try { checked ? f.check?.() : f.uncheck?.(); } catch(e) { /* silencieux */ }
  }

  // ===== Mapping des champs (basé sur l'extraction fournie) =====
  // Ajoute des alias si nécessaire (ex: apostrophes, accents, variantes)
  const map = {
    nomProjet: ["NomProjet","Nom du projet","Nom Projet"],
    numProjet: ["Num Projet","# Projet","NumProjet"],
    metierCCQ: ["Métier CCQ","Metier CCQ"],
    echeanceCCQ: ["Échéance Carte CCQ","Echéance Carte CCQ","Échéance carte CCQ"],
    nomTravailleur: ["NomTravailleur","Travailleur  Prénom et Nom en lettres moulées","Prénom et Nom"],
    entreprise: ["Entreprise"],
    tel1: ["Téléphone","Telephone"],
    tel2: ["Téléphone_2","Telephone_2"],
    tel3: ["Téléphone_3","Telephone_3"],
    contactUrgence: ["Contact durgence","Contact d'urgence","Contact urgence"],
    rss: ["Rss"],
    santePb: ["sante_pb"],

    // Formations
    Cadenassage: ["Cadenassage"],
    Amiante: ["Amiante","Amiante /silice","Amiante / silice"],
    EspaceClos: ["Espace clos"],
    Secourisme: ["Secourisme en milieu de travail"],
    Nacelle: ["Nacelle"],
    ProtectionRespiratoire: ["Protection respiratoire","Protection respiratoire    Fit Test 2ans"],
    SIMDUT: ["SIMDUT 2015 obligatoire","SIMDUT"],
    Plateforme: ["Plateforme élévatrice"],
    Autres: ["Autres"],

    // Sujets traités
    RisquesGeneraux: ["Risque généraux","Risques généraux"],
    RisquesSpecifiques: ["Risques spécifique","Risques spécifiques au chantier"],
    Evacuation: ["Procédure d'évacuation","Procédure d'évacuation / Rassemblement"],
    Accident: ["Procédure en cas d'accident","Prodécure en cas d'accident (trousses, déclaration événement accidentel, formulaire assignation temporaire)"],
    Politiques: ["Politiques drogues et alcools","Politiques alcool, drogues, harcèlement et violence"],
    ToleranceZero: ["Tolérence zéro","Tolérance Zéro"],
    DroitsObligations: ["Droits et obligations"],
    EPI: ["EPI"],

    // Signatures/Dates (si présents)
    date1: ["Date27_es_:signer:date:","Date"],
    date2: ["Date29_es_:signer:date:"],
    signature: ["Signature26_es_:signer:signature:"]
  };

  async function loadTemplate() {
    const url = '/assets/accueil_travailleurs.pdf'; // ← renomme et place ton PDF ici
    const buf = await fetch(url).then(r => {
      if (!r.ok) throw new Error('PDF modèle introuvable à ' + url);
      return r.arrayBuffer();
    });
    return PDFLib.PDFDocument.load(buf);
  }

  function readFormValues() {
    // Récupère les valeurs de l'UI
    const $ = id => document.getElementById(id);
    return {
      nomProjet: $("NomProjet").value,
      numProjet: $("NumProjet").value,
      metierCCQ: $("MetierCCQ").value,
      echeanceCCQ: $("EcheanceCCQ").value, // YYYY-MM-DD
      nomTravailleur: $("NomTravailleur").value,
      entreprise: $("Entreprise").value,
      tel1: $("Telephone").value,
      tel2: $("Telephone2").value,
      tel3: $("Telephone3").value,
      contactUrgence: $("ContactUrgence").value,
      rss: $("Rss").value === 'Oui',
      santePb: $("SantePb").value === 'Oui',
      santeDetails: $("SanteDetails").value,

      formations: {
        Cadenassage: $("Cadenassage").checked,
        Amiante: $("Amiante").checked,
        EspaceClos: $("EspaceClos").checked,
        Secourisme: $("Secourisme").checked,
        Nacelle: $("Nacelle").checked,
        ProtectionRespiratoire: $("ProtectionRespiratoire").checked,
        SIMDUT: $("SIMDUT").checked,
        Plateforme: $("Plateforme").checked,
        Autres: $("Autres").checked,
      },
      sujets: {
        RisquesGeneraux: $("RisquesGeneraux").checked,
        RisquesSpecifiques: $("RisquesSpecifiques").checked,
        Evacuation: $("Evacuation").checked,
        Accident: $("Accident").checked,
        Politiques: $("Politiques").checked,
        ToleranceZero: $("ToleranceZero").checked,
        DroitsObligations: $("DroitsObligations").checked,
        EPI: $("EPI").checked,
      },
      engagement: $("Engagement").checked,
    };
  }

  async function buildPdf({ flatten = false, preview = false, share = false } = {}) {
    const pdf = await loadTemplate();
    const form = pdf.getForm();

    // Debug : liste les champs détectés (ouvre F12)
    try {
      console.log('Champs détectés →');
      for (const f of form.getFields()) {
        console.log('-', f.getName());
      }
    } catch(e) {}

    const v = readFormValues();

    // Texte
    setText(form, map.nomProjet, v.nomProjet);
    setText(form, map.numProjet, v.numProjet);
    setText(form, map.metierCCQ, v.metierCCQ);
    // Date CCQ → format local (YYYY-MM-DD → DD/MM/YYYY)
    const d = v.echeanceCCQ ? new Date(v.echeanceCCQ) : null;
    const dStr = d ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` : '';
    setText(form, map.echeanceCCQ, dStr);

    setText(form, map.nomTravailleur, v.nomTravailleur);
    setText(form, map.entreprise, v.entreprise);
    setText(form, map.tel1, v.tel1);
    setText(form, map.tel2, v.tel2);
    setText(form, map.tel3, v.tel3);
    setText(form, map.contactUrgence, v.contactUrgence);

    // RSS / Santé (beaucoup de formulaires utilisent des cases distinctes Oui/Non ; ici on active juste un flag générique si dispo)
    setCheck(form, map.rss, v.rss);
    setCheck(form, map.santePb, v.santePb);
    // Zone détails santé : si le template a un champ texte dédié, ajoute son nom ici si différent
    setText(form, ["Santé_es_:sender:", "SANTÉ", "Sante_details", "Santé - précisez"], v.santeDetails);

    // Formations
    for (const key of Object.keys(v.formations)) {
      setCheck(form, map[key] || [key], !!v.formations[key]);
    }

    // Sujets traités
    for (const key of Object.keys(v.sujets)) {
      setCheck(form, map[key] || [key], !!v.sujets[key]);
    }

    // Engagement (si champ existe)
    setCheck(form, ["ENGAGEMENT DU TRAVAILLEUR","Engagement"], v.engagement);

    // Dates signature (met la date du jour si champs trouvés)
    const today = new Date();
    const todayStr = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
    setText(form, map.date1, todayStr);
    setText(form, map.date2, todayStr);

    if (flatten) form.flatten();

    const bytes = await pdf.save();
    const file = new File([bytes], `Formulaire_PRD_${Date.now()}.pdf`, { type:'application/pdf' });

    if (share && navigator.canShare?.({ files:[file] })) {
      try { await navigator.share({ files:[file], title:'Formulaire PRD' }); return; } catch(e) { /* annulé */ }
    }

    if (preview) {
      const url = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
      window.open(url, '_blank');
      return;
    }

    // Téléchargement par défaut
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
    a.download = file.name;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // ===== Boutons =====
  document.getElementById('btnGen')        .addEventListener('click', () => buildPdf({ flatten:false }));
  document.getElementById('btnGenFlatten') .addEventListener('click', () => buildPdf({ flatten:true }));
  document.getElementById('btnPreview')    .addEventListener('click', () => buildPdf({ preview:true }));
  document.getElementById('btnShare')      .addEventListener('click', () => buildPdf({ share:true }));
  </script>
</body>
</html>
