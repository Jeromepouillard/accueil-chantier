<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Accueil Chantier – Remplissage PDF (100% gratuit)</title>
    <style>
        /* Styles généraux pour l'ensemble du corps du document */
        :root { --brand:#0f172a; --accent:#0ea5e9; --muted:#e5e7eb; }
        * { box-sizing:border-box }
        html { height:100%; } /* S'assurer que html prend toute la hauteur */
        body{
            min-height:100vh; /* S'assurer que body prend au moins toute la hauteur du viewport */
            margin:0;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            color:var(--brand);
            /* Ajout du fond nid d'abeille ici */
            background: #fff url("assets/bg-honeycomb.png") center/340px repeat;
            padding:24px; /* Garder le padding autour de la carte */
            overflow-y: auto; /* Permettre le défilement vertical si le contenu dépasse */
            display: block; /* Assurer que body se comporte comme un bloc */
        }
        
        /* Styles de la carte principale qui contient le formulaire */
        .card{
            width:100%;
            max-width:900px;
            /* La carte doit être légèrement transparente pour voir l'arrière-plan */
            background: rgba(255,255,255,0.9); 
            backdrop-filter: saturate(120%) blur(2px); /* Effet de flou pour le fond */
            border:1px solid var(--muted);
            border-radius:16px;
            padding:24px;
            box-shadow:0 10px 30px rgba(2,8,23,.06);
            /* Min-height pour s'assurer qu'elle prend de la place, même avec peu de contenu */
            min-height: 200px; 
            margin: 0 auto; /* Centre la carte horizontalement */
        }
        
        /* Styles de l'en-tête de la carte (logo et titre) */
        header { 
            display: flex; 
            flex-direction: column; /* Empile les éléments (logo et div de texte) verticalement */
            align-items: center; /* Centre les éléments horizontalement dans l'en-tête */
            gap: 8px; /* Réduit l'espace entre le logo et le texte */
            margin-bottom: 12px; 
            text-align: center; /* Centre le texte à l'intérieur du div si nécessaire */
        }
        header img {
            /* Rendre le logo responsive */
            max-height: 40px; /* Hauteur maximale par défaut */
            max-width: 100%; /* S'assure que le logo ne dépasse pas la largeur du conteneur */
            height: auto; /* Maintient les proportions */
            width: auto; /* La largeur s'adapte automatiquement */
        }
        /* Media query pour les petits écrans (téléphones) */
        @media (max-width: 480px) {
            header img {
                max-height: 32px; /* Réduit la taille du logo sur les petits écrans */
            }
        }

        h1{font-size:clamp(20px,3.8vw,28px);margin:8px 0}
        
        /* Styles pour la disposition des éléments de formulaire en grille */
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
        
        /* Styles des étiquettes de formulaire */
        label{font-weight:600;font-size:14px}
        
        /* Styles des champs de saisie, textarea et select */
        input,textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
        
        /* Styles pour les lignes (par ex. pour les sélecteurs Oui/Non) */
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        
        /* Styles pour les groupes de cases à cocher */
        .checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}
        
        /* Styles pour les sections du formulaire */
        .section{border-top:1px solid var(--muted);margin-top:16px;padding-top:16px}
        
        /* Styles du conteneur des boutons d'action */
        .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
        
        /* Styles des boutons */
        button{appearance:none;border:1px solid #cbd5e1;background:#f8fafc;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer}
        button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
        button:active{transform:translateY(1px)}
        
        /* Styles pour le texte "muted" (petits messages d'information) */
        small.muted{display:block;margin-top:6px;color:#64748b}
        
        /* Styles pour les éléments alignés en ligne (par ex. label + select) */
        .inline{display:flex;align-items:center;gap:10px}

        /* Styles spécifiques pour la zone de signature */
        #signatureCanvas {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background-color: #f8fafc;
            touch-action: none; /* Empêche le défilement lors du dessin */
        }
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <main class="card">
        <header>
            <img src="assets/logo-prdesjardins.png" alt="P+R Desjardins"/>
            <div>
                <h1>Accueil des travailleurs — Générateur PDF éditable</h1>
                <small class="muted">
                    Place le PDF modèle à <code>/assets/accueil_travailleurs.pdf</code> (ton original renommé).
                    Rien à payer, tout dans le navigateur.
                </small>
            </div>
        </header>

        <form id="form" onsubmit="return false;">
            <!-- Section Informations du projet -->
            <div class="grid">
                <div>
                    <label for="NomProjet">Nom du projet</label>
                    <input id="NomProjet" placeholder="Ex: Tour XYZ" />
                </div>
                <div>
                    <label for="NumProjet"># Projet</label>
                    <input id="NumProjet" placeholder="Ex: 12345" /> <!-- Placeholder modifié -->
                </div>
                <div>
                    <label for="MetierCCQ">Métier CCQ</label>
                    <input id="MetierCCQ" />
                </div>
                <div>
                    <label for="EcheanceCCQ">Échéance carte CCQ</label>
                    <input id="EcheanceCCQ" type="date" />
                </div>
                <div>
                    <label for="NomTravailleur">Prénom et Nom</label>
                    <input id="NomTravailleur" />
                </div>
                <div>
                    <label for="Entreprise">Entreprise</label>
                    <input id="Entreprise" />
                </div>
                <div>
                    <label for="Telephone">Téléphone (principal)</label> <!-- Libellé modifié -->
                    <input id="Telephone" type="tel" />
                </div>
                <div>
                    <label for="Telephone2">Téléphone (secondaire)</label> <!-- Libellé modifié -->
                    <input id="Telephone2" type="tel" />
                </div>
                <div>
                    <label for="Telephone3">Téléphone (contact d'urgence)</label> <!-- Libellé modifié -->
                    <input id="Telephone3" type="tel" />
                </div>
                <div>
                    <label for="ContactUrgence">Nom du contact d'urgence</label> <!-- Libellé modifié -->
                    <input id="ContactUrgence" />
                </div>
            </div>

            <!-- Section RSS et Problème de santé -->
            <div class="section">
                <div class="row">
                    <div class="inline">
                        <label for="Rss">Êtes‑vous intéressé à être RSS ?</label>
                        <select id="Rss"><option value="Non">Non</option><option value="Oui">Oui</option></select>
                    </div>
                    <div class="inline">
                        <label for="SantePb">Problème de santé ?</label>
                        <select id="SantePb"><option value="Non">Non</option><option value="Oui">Oui</option></select>
                    </div>
                </div>
                <label for="SanteDetails">Précisez (si Oui)</label>
                <textarea id="SanteDetails" rows="2" placeholder="Asthme, allergie, etc."></textarea>
            </div>

            <!-- Nouvelle Section : OBLIGATIONS EN TOUT TEMPS -->
            <div class="section">
                <h3>OBLIGATIONS EN TOUT TEMPS</h3>
                <p>
                    <strong>TRAVAUX EN COLLABORATION AVEC P+R</strong><br>
                    <strong>TOLÉRANCE ZÉRO</strong> En tout temps, les travaux doivent être exécutés de façon sécuritaire pour soi et pour tous les autres travailleurs présents sur le chantier, il est de la responsabilité de chacun de limiter au maximum les différents risques liés aux travaux. Poussière de silice cristalline - port d'appareil de protection respiratoire visage rasé OBLIGATOIRE, procédé humide ou captation à la source - Système de ventilation locale - isolation des postes de travail, Amiante suivre les recommandations selon le niveau de contamination, port des EPI équipements de protection individuels obligatoires, sécurité des machines, inspections obligatoires et s'assurer de la présence de dispositifs de sécurité.
                </p>
            </div>

            <!-- Section Engagement du travailleur -->
            <div class="section">
                <h3>ENGAGEMENT DU TRAVAILLEUR</h3>
                <p class="subtle" style="margin-bottom: 10px;">
                    Sur l'ensemble des chantiers, les règles de sécurité telles que décrites dans le Code de Santé et Sécurité pour les travaux de construction s'appliquent.
                </p>
                <div class="inline">
                    <input type="checkbox" id="Engagement" />
                    <label for="Engagement">Je m'engage à prendre connaissance du programme de prévention de l'entrepreneur général applicable au chantier, des tolérances zéro de la CNESST et je m'engage à les respecter. Notamment, je m'engage à n'entreprendre aucun travail pour lesquels j'ai constaté un risque pour ma sécurité ou celle d'une autre personne et d'aviser dès que possible mon supérieur immédiat de tout risque constaté. Je m'engage également à ne pas effectuer ou opérer de machinerie sans avoir préalablement avoir reçu la formation concernant les risques spécifiques. J'ai été informé de la gradation des mesures disciplinaires, des consignes à suivre lors d'un accident de travail avec ou sans perte de temps et j'ai fait la visite du chantier.</label>
                </div>
            </div>

            <!-- Nouvelle Section : Bas du formulaire (Nom, Signature, Date) -->
            <div class="section">
                <div class="grid">
                    <div>
                        <label for="TravailleurNomFinal">Travailleur: (Prénom et Nom en lettres moulées)</label>
                        <input id="TravailleurNomFinal" type="text" />
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label>Signature</label>
                    <canvas id="signatureCanvas" width="400" height="100"></canvas>
                    <div class="signature-controls">
                        <button type="button" id="clearSignature">Effacer la signature</button>
                    </div>
                </div>
                
                <div class="grid" style="margin-top: 20px;">
                    <div>
                        <label for="DateFinale">Date</label>
                        <input id="DateFinale" type="date" />
                    </div>
                </div>
            </div>

            <!-- Boutons d'action pour le PDF -->
            <div class="btns">
                <button class="primary" id="btnGen">Générer le PDF (éditable)</button>
                <button id="btnGenFlatten">Générer (aplati pour impression)</button>
                <button id="btnPreview">Prévisualiser dans le navigateur</button>
                <button id="btnShare">Partager (mobile)</button>
            </div>
            <small class="muted">
                Astuce: ouvre la console F12 pour voir la liste exacte des noms de champs détectés dans le PDF (utile si certains noms varient).
            </small>
        </form>
    </main>

    <!-- Importation de la bibliothèque pdf-lib pour la manipulation de PDF -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // Utilitaires pour gérer les noms de champs PDF qui peuvent varier
        // Permet de trouver un champ par plusieurs noms possibles
        function getFieldByNames(form, names) {
            for (const n of names) {
                try { return form.getField(n); } catch(e) {}
            }
            return null; // Retourne null si aucun champ n'est trouvé avec les noms donnés
        }

        // Définit le texte d'un champ PDF
        function setText(form, names, value) {
            const f = getFieldByNames(form, names);
            if (f && f.setText) { f.setText(value ?? ''); } // Utilise la valeur ou une chaîne vide
        }

        // Coche ou décoche une case à cocher dans le PDF
        function setCheck(form, names, checked) {
            const f = getFieldByNames(form, names);
            if (!f) return; // Ne fait rien si le champ n'est pas trouvé
            try { checked ? f.check?.() : f.uncheck?.(); } catch(e) { /* Gère silencieusement les erreurs */ }
        }

        // Mapping des IDs des éléments HTML avec les noms des champs PDF
        // Cela permet de connecter facilement le formulaire HTML au PDF
        const map = {
            // En-tête du formulaire
            nomProjet: ["NomProjet","Nom du projet","Nom Projet"],
            numProjet: ["Num Projet","# Projet","NumProjet"], 
            metierCCQ: ["Métier CCQ","Metier CCQ"],
            echeanceCCQ: ["Échéance Carte CCQ","Echeance Carte CCQ","Échéance carte CCQ"],

            // Coordonnées du travailleur
            nomTravailleur: ["NomTravailleur","Travailleur Prénom et Nom en lettres moulées","Prénom et Nom"],
            entreprise: ["Entreprise"],
            tel1: ["Téléphone","Telephone"],
            tel2: ["Téléphone_2","Telephone_2"],
            tel3: ["Téléphone_3","Telephone_3"],
            contactUrgence: ["Contact durgence","Contact d'urgence","Contact urgence"],

            // Choix Oui/Non (stockés en texte dans le PDF original)
            rss: ["Rss"],
            sante_pb: ["sante_pb"],
            sante_details: ["Santé_es_:sender:", "SANTÉ", "Sante_details", "Santé - précisez"],

            // Formations (cases à cocher)
            Cadenassage: ["Cadenassage"],
            Amiante: ["Amiante","Amiante /silice","Amiante / silice"],
            EspaceClos: ["Espace clos"],
            Secourisme: ["Secourisme en milieu de travail"],
            Nacelle: ["Nacelle"],
            ProtectionRespiratoire: ["Protection respiratoire","Protection respiratoire   Fit Test 2ans"],
            SIMDUT: ["SIMDUT 2015 obligatoire","SIMDUT"],
            Plateforme: ["Plateforme élévatrice"],
            Autres: ["Autres"],

            // Sujets traités (RETIRE du formulaire HTML, mais peut exister dans le PDF)
            // Nous ne les remplirons plus via l'UI, mais ils ne causeront pas d'erreur s'ils existent dans le PDF.
            RisquesGeneraux: ["Risque généraux","Risques généraux"],
            RisquesSpecifiques: ["Risques spécifique","Risques spécifiques au chantier"],
            Evacuation: ["Procédure d'évacuation","Procédure d'évacuation / Rassemblement"],
            Accident: ["Procédure en cas d'accident","Prodécure en cas d'accident (trousses, déclaration événement accidentel, formulaire assignation temporaire)"],
            Politiques: ["Politiques drogues et alcools","Politiques alcool, drogues, harcèlement et violence"],
            ToleranceZero: ["Tolérence zéro","Tolérances Zéro","Tolérance Zéro"],
            DroitsObligations: ["Droits et obligations"],
            EPI: ["EPI"],

            // Engagement du travailleur (case à cocher)
            Engagement: ["Case à cocher24","ENGAGEMENT DU TRAVAILLEUR","Engagement"],

            // Nouveaux champs pour le bas du formulaire (Travailleur Nom Final, Date Finale)
            // Signature ne sera PAS un champ de formulaire PDF mais une image ajoutée.
            travailleurNomFinal: ["Travailleur: (Prénom et Nom en lettres moulées)","Nom et Prénom","Nom Prenom"], // Ajouté pour le champ de texte
            dateFinale: ["Date Finale", "Date"] // Ajouté pour la date du bas
        };

        // Charge le modèle PDF à partir de l'URL spécifiée
        async function loadTemplate() {
            const url = 'assets/accueil_travailleurs.pdf'; 
            const buf = await fetch(url).then(r => {
                if (!r.ok) throw new Error('PDF modèle introuvable à ' + url);
                return r.arrayBuffer();
            });
            return PDFLib.PDFDocument.load(buf);
        }

        // Lit les valeurs du formulaire HTML
        function readFormValues() {
            const $ = id => document.getElementById(id);
            const values = {
                nomProjet: $("NomProjet").value,
                numProjet: $("NumProjet").value,
                metierCCQ: $("MetierCCQ").value,
                echeanceCCQ: $("EcheanceCCQ").value,
                nomTravailleur: $("NomTravailleur").value,
                entreprise: $("Entreprise").value,
                tel1: $("Telephone").value,
                tel2: $("Telephone2").value,
                tel3: $("Telephone3").value,
                contactUrgence: $("ContactUrgence").value,
                rss: $("Rss").value === 'Oui',
                santePb: $("SantePb").value === 'Oui',
                santeDetails: $("SanteDetails").value,
                
                formations: {
                    Cadenassage: $("Cadenassage").checked,
                    Amiante: $("Amiante").checked,
                    EspaceClos: $("EspaceClos").checked,
                    Secourisme: $("Secourisme").checked,
                    Nacelle: $("Nacelle").checked,
                    ProtectionRespiratoire: $("ProtectionRespiratoire").checked,
                    SIMDUT: $("SIMDUT").checked,
                    Plateforme: $("Plateforme").checked,
                    Autres: $("Autres").checked,
                },
                
                // Sujets traités NE SONT PLUS lus de l'UI
                // mais on peut toujours les cocher/décocher dans le PDF si nécessaire via `buildPdf`
                // par exemple, setCheck(form, map.RisquesGeneraux, true);

                engagement: $("Engagement").checked,

                // Nouveaux champs du bas de page
                travailleurNomFinal: $("TravailleurNomFinal").value,
                dateFinale: $("DateFinale").value,
                signatureData: getSignatureData(), // Récupère l'image de la signature
            };

            localStorage.setItem('lastTravailleurName', values.nomTravailleur);
            return values;
        }

        // Fonctions pour la signature sur canvas
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function resizeCanvas() {
            // S'assurer que le canvas prend toute la largeur disponible dans son parent
            canvas.width = canvas.offsetWidth;
            // Pour maintenir une hauteur raisonnable sur mobile, on peut la fixer ou la calculer
            canvas.height = 100; // Ou une valeur calculée si nécessaire
            ctx.fillStyle = "#f8fafc"; // Fond clair pour la signature
            ctx.fillRect(0, 0, canvas.width, canvas.height); // Remplir le fond
            ctx.strokeStyle = '#000'; // Couleur du trait
            ctx.lineWidth = 2; // Épaisseur du trait
            ctx.lineCap = 'round'; // Bords arrondis
        }

        // Redimensionne le canvas au chargement et lors du redimensionnement de la fenêtre
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mousemove', draw);
        // Support tactile
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Empêche le défilement
            startDrawing(e.touches[0]);
        });
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Empêche le défilement
            draw(e.touches[0]);
        });

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            const rect = canvas.getBoundingClientRect();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing() {
            drawing = false;
        }

        document.getElementById('clearSignature').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#f8fafc"; // Réapplique le fond clair après effacement
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        // Fonction pour récupérer les données de la signature (image)
        function getSignatureData() {
            // Vérifie si quelque chose a été dessiné (non vide)
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let hasContent = false;
            for (let i = 0; i < imageData.data.length; i += 4) {
                // Si la composante alpha (transparence) est > 0, il y a du contenu dessiné
                if (imageData.data[i + 3] > 0 && imageData.data[i] !== 248 && imageData.data[i+1] !== 250 && imageData.data[i+2] !== 252) { // Exclut la couleur de fond #f8fafc
                    hasContent = true;
                    break;
                }
            }
            if (hasContent) {
                return canvas.toDataURL('image/png');
            }
            return null; // Retourne null si le canvas est vide
        }

        // Pré-remplir la date du jour pour "DateFinale"
        window.addEventListener('load', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('DateFinale').value = `${year}-${month}-${day}`;
            resizeCanvas(); // Assure que le canvas est bien dimensionné au chargement
        });


        // Fonction principale pour construire le PDF
        async function buildPdf({ flatten = false, preview = false, share = false } = {}) {
            const pdf = await loadTemplate(); // Charge le PDF modèle
            const form = pdf.getForm(); // Accède aux champs du formulaire PDF
            const pages = pdf.getPages(); // Accède aux pages du PDF

            // Debug : Affiche la liste des noms de champs détectés dans le PDF (pour débugger le mapping)
            try {
                console.log('Champs détectés dans le PDF →');
                for (const f of form.getFields()) {
                    console.log('-', f.getName());
                }
            } catch(e) {
                console.error("Erreur lors de la lecture des champs PDF:", e);
            }

            const v = readFormValues(); // Récupère les valeurs du formulaire HTML

            // Remplissage des champs de texte
            setText(form, map.nomProjet, v.nomProjet);
            setText(form, map.numProjet, v.numProjet);
            setText(form, map.metierCCQ, v.metierCCQ);
            
            // Conversion de la date (YYYY-MM-DD en DD/MM/YYYY)
            const d = v.echeanceCCQ ? new Date(v.echeanceCCQ) : null;
            const dStr = d ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` : '';
            setText(form, map.echeanceCCQ, dStr);

            setText(form, map.nomTravailleur, v.nomTravailleur);
            setText(form, map.entreprise, v.entreprise);
            setText(form, map.tel1, v.tel1);
            setText(form, map.tel2, v.tel2);
            setText(form, map.tel3, v.tel3);
            setText(form, map.contactUrgence, v.contactUrgence);

            // Remplissage des sélecteurs Oui/Non (qui sont des champs de texte dans le PDF)
            setText(form, map.rss, v.rss ? 'Oui' : 'Non');
            setText(form, map.sante_pb, v.santePb ? 'Oui' : 'Non');
            setText(form, map.sante_details, v.santeDetails);

            // Remplissage des cases à cocher pour les formations
            for (const key of Object.keys(v.formations)) {
                setCheck(form, map[key] || [key], !!v.formations[key]);
            }
            
            // Les "Sujets traités" ne sont plus dans le formulaire HTML, donc nous ne les mappons pas ici.
            // Si vous voulez cocher certains de ces champs par défaut dans le PDF, faites-le ici.
            // Ex: setCheck(form, map.RisquesGeneraux, true); // Pour cocher "Risques généraux" automatiquement

            setText(form, map.travailleurNomFinal, v.travailleurNomFinal);
            
            // Remplissage des dates de signature (avec la date du jour)
            const today = new Date();
            const todayStr = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
            // map.date1 et map.date2 sont pour les dates en haut du PDF, si elles existent.
            // Sinon, nous utilisons dateFinale pour le bas.
            setText(form, map.date1, todayStr); 
            setText(form, map.date2, todayStr);
            setText(form, map.dateFinale, todayStr); // Remplit la date en bas du PDF

            // Remplissage de la case à cocher d'engagement
            setCheck(form, map.Engagement, v.engagement);

            // GESTION DE LA SIGNATURE DESSINÉE
            if (v.signatureData) {
                try {
                    const signatureImage = await pdf.embedPng(v.signatureData);
                    // Détermine la dernière page pour placer la signature
                    const lastPage = pages[pages.length - 1]; 
                    
                    // Ces coordonnées (x, y) et dimensions (width, height) sont des estimations.
                    // Pour un placement pixel-par-pixel parfait sur le champ "Signature" du PDF,
                    // il faudrait connaître les coordonnées exactes de ce champ dans le PDF
                    // ou ajouter une nouvelle page dédiée à la signature si l'intégration est difficile.
                    // Ici, on va tenter de la placer à un endroit raisonnable en bas de la dernière page.
                    // Ces valeurs sont à ajuster précisément en fonction de votre PDF.
                    const imageWidth = 100; // Largeur désirée pour l'image de signature en mm
                    const imageHeight = signatureImage.height * imageWidth / signatureImage.width;
                    const x = 50; // Position X en mm
                    const y = 50; // Position Y en mm (depuis le bas de la page, donc 297-y pour le haut)
                    
                    lastPage.drawImage(signatureImage, {
                        x: x,
                        y: lastPage.getHeight() - y - imageHeight, // Calcule la position Y depuis le haut
                        width: imageWidth,
                        height: imageHeight,
                    });
                } catch (error) {
                    console.error("Erreur lors de l'intégration de la signature :", error);
                    alert("Attention : La signature n'a pas pu être intégrée au PDF.");
                }
            } else {
                 alert("Attention : Veuillez signer le document avant de générer le PDF.");
            }


            // Si "flatten" est vrai, les champs du formulaire sont fusionnés avec le document
            // Cela les rend non éditables une fois le PDF généré
            if (flatten) form.flatten();

            const bytes = await pdf.save(); // Sauvegarde le PDF modifié
            const filename = `Formulaire_PRD_${v.nomTravailleur.replace(/\s+/g, '_') || 'sans_nom'}_${Date.now()}.pdf`;
            const file = new File([bytes], filename, { type:'application/pdf' });

            // Stockage local pour la page d'accueil (optionnel si non utilisé)
            localStorage.setItem('generatedPdf', URL.createObjectURL(file)); 
            localStorage.setItem('generatedPdfFileName', filename); 

            // Option de partage (Web Share API, idéal pour mobile)
            if (share && navigator.canShare?.({ files:[file] })) {
                try { 
                    await navigator.share({ files:[file], title:'Formulaire PRD', text:'Voici votre formulaire PRD rempli.' }); 
                } catch(e) { 
                    console.error("Erreur de partage:", e);
                }
            }
            // Option de prévisualisation dans une nouvelle fenêtre/onglet
            else if (preview) {
                const url = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
                window.open(url, '_blank');
            }
            // Téléchargement par défaut
            else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
                a.download = file.name;
                document.body.appendChild(a); 
                a.click(); 
                a.remove();
            }
        }

        // Événements des boutons
        document.getElementById('btnGen').addEventListener('click', () => buildPdf({ flatten:false }));
        document.getElementById('btnGenFlatten').addEventListener('click', () => buildPdf({ flatten:true }));
        document.getElementById('btnPreview').addEventListener('click', () => buildPdf({ preview:true }));
        document.getElementById('btnShare').addEventListener('click', () => buildPdf({ share:true }));
    </script>
</body>
</html>
