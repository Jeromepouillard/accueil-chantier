<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Accueil Chantier – Remplissage PDF </title>
    <style>
        /* Styles généraux pour l'ensemble du corps du document */
        :root { --brand:#0f172a; --accent:#0ea5e9; --muted:#e5e7eb; }
        * { box-sizing:border-box }
        html { height:100%; }
        body{
            min-height:100vh;
            margin:0;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            color:var(--brand);
            background: #fff url("assets/bg-honeycomb.png") center/340px repeat;
            padding:24px;
            overflow-y: auto;
            display: block;
        }
        
        /* Styles de la carte principale qui contient le formulaire */
        .card{
            width:100%;
            max-width:900px;
            background: rgba(255,255,255,0.9); 
            backdrop-filter: saturate(120%) blur(2px);
            border:1px solid var(--muted);
            border-radius:16px;
            padding:24px;
            box-shadow:0 10px 30px rgba(2,8,23,.06);
            min-height: 200px; 
            margin: 0 auto;
        }
        
        /* Styles de l'en-tête de la carte (logo et titre) */
        header { 
            display: flex; 
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px; 
            text-align: center;
        }
        header img {
            max-height: 40px;
            max-width: 100%;
            height: auto;
            width: auto;
        }
        /* Media query pour les petits écrans (téléphones) */
        @media (max-width: 480px) {
            header img {
                max-height: 32px;
            }
        }

        h1{font-size:clamp(20px,3.8vw,28px);margin:8px 0}
        
        /* Styles pour la disposition des éléments de formulaire en grille */
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
        
        /* Styles des étiquettes de formulaire */
        label{font-weight:600;font-size:14px}
        
        /* Styles des champs de saisie, textarea et select */
        input,textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
        
        /* Styles pour les lignes (par ex. pour les sélecteurs Oui/Non) */
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        
        /* Styles pour les groupes de cases à cocher */
        .checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}

        /* NOUVEAUX STYLES POUR LES LABELS CONTENANT DES CASES À COCHER */
        .checkboxes label,
        .inline label:has(input[type="checkbox"]) {
            display: flex;
            align-items: center;
            font-weight: normal;
            font-size: 1rem;
        }
        .checkboxes label input[type="checkbox"],
        .inline label input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        /* Styles pour les sections du formulaire */
        .section{border-top:1px solid var(--muted);margin-top:16px;padding-top:16px}
        
        /* Styles du conteneur des boutons d'action */
        .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
        
        /* Styles des boutons */
        button{appearance:none;border:1px solid #cbd5e1;background:#f8fafc;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer}
        button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
        button:active{transform:translateY(1px)}
        
        /* Styles pour le texte "muted" (petits messages d'information) */
        small.muted{display:block;margin-top:6px;color:#64748b}
        
        /* Styles pour les éléments alignés en ligne (par ex. label + select) */
        .inline{display:flex;align-items:center;gap:10px}

        /* Styles spécifiques pour la zone de signature */
        #signatureCanvas {
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), 
                                linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            touch-action: none;
            position: relative;
            width: 100%;
            height: 120px;
        }
        #signatureCanvas::after {
            content: none; 
        }
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .required-asterisk {
            color: red;
        }
    </style>
</head>
<body>
    <main class="card">
        <header>
            <img src="assets/logo-prdesjardins.png" alt="P+R Desjardins"/>
            <div>
                <h1>Accueil des travailleurs — Formulaire PDF à remplir </h1>
                <small class="muted">
                    Veuillez remplir tous les champs obligatoires marqués d'un astérisque (*).
                </small>
            </div>
        </header>

        <form id="form" onsubmit="return false;">
            <div class="grid">
                <div>
                    <label for="NomProjet">Nom du projet / adresse  <span class="required-asterisk">*</span></label>
                    <input id="NomProjet" placeholder="Ex: Tour XYZ" required />
                </div>
                <div>
                    <label for="DateDuJour">Date du jour <span class="required-asterisk">*</span></label>
                    <input id="DateDuJour" type="date" required />
                </div>
                <div>
                    <label for="MetierCCQ">Métier CCQ <span class="required-asterisk">*</span></label>
                    <input id="MetierCCQ" required />
                </div>
                <div>
                    <label for="EcheanceCCQ">Échéance carte CCQ <span class="required-asterisk">*</span></label>
                    <input id="EcheanceCCQ" type="date" required />
                </div>
                <div>
                    <label for="NomTravailleur">Prénom et Nom <span class="required-asterisk">*</span></label>
                    <input id="NomTravailleur" required />
                </div>
                <div>
                    <label for="Entreprise">Entreprise <span class="required-asterisk">*</span></label>
                    <input id="Entreprise" required />
                </div>
                <div>
                    <label for="Telephone">Téléphone (principal) <span class="required-asterisk">*</span></label>
                    <input id="Telephone" type="tel" required />
                </div>
                <div>
                    <label for="Telephone3">Téléphone (contact d'urgence) <span class="required-asterisk">*</span></label>
                    <input id="Telephone3" type="tel" required />
                </div>
                <div>
                    <label for="ContactUrgence">Nom du contact d'urgence <span class="required-asterisk">*</span></label>
                    <input id="ContactUrgence" required />
                </div>
            </div>

            <div class="section">
                <div class="inline">
                    <label for="Rss">Êtes‑vous intéressé à être RSS à temps partiel ? <span class="required-asterisk">*</span></label>
                    <select id="Rss" required><option value="Non">Non</option><option value="Oui">Oui</option></select>
                </div>
            </div>

            <div class="section">
                <h3 style="color: #FF0000;">OBLIGATIONS EN TOUT TEMPS</h3>
                <p>
                    <strong>TRAVAUX EN COLLABORATION AVEC P+R</strong><br>
                    <strong>TOLÉRANCE ZÉRO</strong> En tout temps, les travaux doivent être exécutés de façon sécuritaire pour soi et pour tous les autres travailleurs présents sur le chantier, il est de la responsabilité de chacun de limiter au maximum les différents risques liés aux travaux. Poussière de silice cristalline - port d'appareil de protection respiratoire visage rasé OBLIGATOIRE, procédé humide ou captation à la source - Système de ventilation locale - isolation des postes de travail, Amiante suivre les recommandations selon le niveau de contamination, port des EPI équipements de protection individuels obligatoires, sécurité des machines, inspections obligatoires et s'assurer de la présence de dispositifs de sécurité.
                </p>
            </div>

            <div class="section">
                <h3 style="color: #FF0000;">SANTÉ</h3>
                <div class="inline">
                    <label for="SantePb">Avez-vous un problème de santé que nous devrions connaître? <span class="required-asterisk">*</span></label>
                    <select id="SantePb" required><option value="Non">Non</option><option value="Oui">Oui</option></select>
                </div>
                <label for="SanteDetails">Précisez (si Oui)</label>
                <textarea id="SanteDetails" rows="2" placeholder="Asthme, allergie, etc."></textarea>
            </div>

            <div class="section">
                <h3 style="color: #FF0000;">FORMATIONS DU TRAVAILLEUR <span class="required-asterisk">*</span></h3>
                <div class="checkboxes" id="formationsCheckboxes">
                    <label><input type="checkbox" id="Cadenassage"> Cadenassage</label>
                    <label><input type="checkbox" id="Amiante"> Amiante / silice</label>
                    <label><input type="checkbox" id="EspaceClos"> Espace clos</label>
                    <label><input type="checkbox" id="Secourisme"> Secourisme en milieu de travail</label>
                    <label><input type="checkbox" id="Nacelle"> Nacelle</label>
                    <label><input type="checkbox" id="ProtectionRespiratoire"> Protection respiratoire (Fit Test 2 ans)</label>
                    <label><input type="checkbox" id="SIMDUT"> SIMDUT 2015 obligatoire</label>
                    <label><input type="checkbox" id="Plateforme"> Plateforme élévatrice</label>
                    <label><input type="checkbox" id="Autres"> Autres</label>
                </div>
            </div>

            <div class="section">
                <h3 style="color: #FF0000;">APPLICATION DES MESURES DISCIPLINAIRES *</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background-color: #f8fafc;">
                            <th style="border: 1px solid #cbd5e1; padding: 8px; text-align: left; width: 25%;">Offense</th>
                            <th style="border: 1px solid #cbd5e1; padding: 8px; text-align: left;">Mesure</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #cbd5e1; padding: 8px;">1<sup>ère</sup> offense</td>
                            <td style="border: 1px solid #cbd5e1; padding: 8px;">Avertissement verbal</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #cbd5e1; padding: 8px;">2<sup>e</sup> offense</td>
                            <td style="border: 1px solid #cbd5e1; padding: 8px;">Avertissement écrit</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #cbd5e1; padding: 8px;">3<sup>e</sup> offense</td>
                            <td style="border: 1px solid #cbd5e1; padding: 8px;">Suspension de 2 jours où le travailleur ne pourra être présent sur le chantier et/ou renvoi du chantier pour toute la période des travaux.</td>
                        </tr>
                    </tbody>
                </table>
                <p class="subtle" style="margin-top: 10px;">
                    * Selon la gravité de l'offense à la Santé et la Sécurité, la suspension et/ou le renvoi du chantier pourront être appliqués immédiatement.
                </p>
            </div>

            <div class="section">
                <h3 style="color: #FF0000;">ENGAGEMENT DU TRAVAILLEUR</h3>
                <p class="subtle" style="margin-bottom: 10px;">
                    Sur l'ensemble des chantiers, les règles de sécurité telles que décrites dans le Code de Santé et Sécurité pour les travaux de construction s'appliquent.
                </p>
                <p style="margin-bottom: 15px;">
                    Je m'engage à prendre connaissance du programme de prévention de l'entrepreneur général applicable au chantier, des tolérances zéro de la CNESST et je m'engage à les respecter. Notamment, je m'engage à n'entreprendre aucun travail pour lesquels j'ai constaté un risque pour ma sécurité ou celle d'une autre personne et d'aviser dès que possible mon supérieur immédiat de tout risque constaté. Je m'engage également à ne pas effectuer ou opérer de machinerie sans avoir préalablement avoir reçu la formation concernant les risques spécifiques. J'ai été informé de la gradation des mesures disciplinaires, des consignes à suivre lors d'un accident de travail avec ou sans perte de temps et j'ai fait la visite du chantier.
                </p>
                <div class="inline" style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="Engagement" required /> 
                        En cochant cette case, je confirme avoir lu l'entièreté du document et de mes engagements. <span class="required-asterisk">*</span>
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="grid">
                    <div>
                        <label for="TravailleurNomFinal">Travailleur: (Prénom et Nom en lettres moulées)</label>
                        <input id="TravailleurNomFinal" type="text" readonly required />
                    </div>
                    <div>
                        <label for="DateFinale">Date</label>
                        <input id="DateFinale" type="date" readonly required />
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label>Signature <span class="required-asterisk">*</span></label>
                    <canvas id="signatureCanvas" width="400" height="100"></canvas>
                    <div class="signature-controls">
                        <button type="button" id="clearSignature">Effacer la signature</button>
                    </div>
                </div>
                
            </div>

            <div class="btns">
                <button class="primary" id="btnGen">Générer le PDF (éditable)</button>
                <button id="btnGenFlatten">Générer (aplati pour impression)</button>
                <button id="btnPreview">Prévisualiser dans le navigateur</button>
                <button id="btnShare">Partager (mobile)</button>
                <button id="btnEmail">Envoyer par courriel (PDF en PJ)</button>
            </div>
            <small class="muted">
                Si vous ne pouvez pas remplir le formulaire en pligne, veuillez en demander un papier au surintendant, merci.
            </small>
        </form>
    </main>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // Utilitaires pour gérer les noms de champs PDF qui peuvent varier
        // Permet de trouver un champ par plusieurs noms possibles
        function getFieldByNames(form, names) {
            // S'assure que 'names' est toujours un tableau
            if (!Array.isArray(names)) {
                console.error("getFieldByNames: 'names' n'est pas un tableau.", names);
                return null;
            }
            for (const n of names) {
                try { return form.getField(n); } catch(e) {}
            }
            return null; // Retourne null si aucun champ n'est trouvé avec les noms donnés
        }

        // Définit le texte d'un champ PDF
        function setText(form, names, value) {
            const f = getFieldByNames(form, names);
            if (f && f.setText) { f.setText(value ?? ''); } // Utilise la valeur ou une chaîne vide
        }
        // Coche ou décoche une case à cocher dans le PDF
        function setCheck(form, names, checked) {
            const f = getFieldByNames(form, names);
            if (!f) return; // Ne fait rien si le champ n'est pas trouvé
            try { checked ? f.check?.() : f.uncheck?.(); } catch(e) { /* Gère silencieusement les erreurs */ }
        }

        // Définit la valeur d'un groupe de boutons radio dans le PDF
        function setRadio(form, names, value) {
            const f = getFieldByNames(form, names);
            // Vérifie si le champ existe et possède la méthode 'select' (caractéristique d'un groupe radio)
            if (f && typeof f.select === 'function') {
                try {
                    // pdf-lib's select method for radio groups takes the export value
                    f.select(value);
                } catch(e) {
                    console.warn(`Erreur lors de la sélection du bouton radio pour le champ ${names.join('/')} avec la valeur '${value}':`, e);
                }
            } else {
                console.warn(`Champ radio ${names.join('/')} non trouvé ou n'est pas un groupe radio.`);
            }
        }

        // Mapping des IDs des éléments HTML avec les noms des champs PDF
        // Cela permet de connecter facilement le formulaire HTML au PDF
        const map = {
            // En-tête du formulaire
            nomProjet: ["NomProjet","Nom du projet","Nom Projet"],
            dateDuJour: ["Date", "Date29_es_:signer:date"], 
            metierCCQ: ["Métier CCQ","Metier CCQ"],
            echeanceCCQ: ["Échéance Carte CCQ","Echeance Carte CCQ","Échéance carte CCQ"],

            // Coordonnées du travailleur
            nomTravailleur: ["NomTravailleur","Travailleur Prénom et Nom en lettres moulées","Prénom et Nom"],
            entreprise: ["Entreprise"],
            tel1: ["Téléphone","Telephone"],
            // tel2: ["Téléphone_2", "Telephone_2"], // Ligne commentée
            tel3: ["Téléphone_3","Telephone_3"],
            contactUrgence: ["Contact durgence","Contact d'urgence","Contact urgence"],

            // Choix Oui/Non (qui sont des groupes radio dans le PDF original)
            rss: ["Rss"], // Nom du groupe radio pour RSS dans le PDF
            sante_pb: ["sante_pb"], // Nom du groupe radio pour Problème de santé dans le PDF
            sante_details: ["Santé", "Santé_es_:sender:", "SANTÉ", "Sante_details", "Santé - précisez"], // Champ texte pour les détails de santé

            // Formations (cases à cocher)
            Cadenassage: ["Cadenassage"],
            Amiante: ["Amiante","Amiante /silice","Amiante / silice"],
            EspaceClos: ["Espace clos"],
            Secourisme: ["Secourisme en milieu de travail"],
            Nacelle: ["Nacelle"],
            ProtectionRespiratoire: ["Protection respiratoire","Protection respiratoire Fit Test 2ans"],
            SIMDUT: ["SIMDUT 2015 obligatoire","SIMDUT"],
            Plateforme: ["Plateforme élévatrice"],
            Autres: ["Autres"],
            
            // Engagement du travailleur (case à cocher)
            Engagement: ["Case à cocher24","ENGAGEMENT DU TRAVAILLEUR","Engagement"],

            // Champs pour le bas du formulaire (seront mis à jour automatiquement via JS)
            travailleurNomFinal: ["Travailleur  Prénom et Nom en lettres moulées"], 
            dateFinale: ["Date27_es_:signer:date", "Date"], 
            signature: ["Signature"], // Nom du champ pour la signature
        };

        // Charge le modèle PDF à partir de l'URL spécifiée
        async function loadTemplate() {
            const url = 'assets/accueil_travailleurs.pdf'; 
            const buf = await fetch(url).then(r => {
                if (!r.ok) throw new Error('PDF modèle introuvable à ' + url);
                return r.arrayBuffer();
            });
            return PDFLib.PDFDocument.load(buf);
        }

        // Lit les valeurs du formulaire HTML
        function readFormValues() {
            const $ = id => document.getElementById(id);
            const values = {
                nomProjet: $("NomProjet").value,
                dateDuJour: $("DateDuJour").value, 
                metierCCQ: $("MetierCCQ").value,
                echeanceCCQ: $("EcheanceCCQ").value,
                nomTravailleur: $("NomTravailleur").value,
                entreprise: $("Entreprise").value,
                tel1: $("Telephone").value,
                tel3: $("Telephone3").value,
                contactUrgence: $("ContactUrgence").value,
                rss: $("Rss").value === 'Oui',
                santePb: $("SantePb").value === 'Oui',
                santeDetails: $("SanteDetails").value,
                
                formations: {
                    Cadenassage: $("Cadenassage").checked,
                    Amiante: $("Amiante").checked,
                    EspaceClos: $("EspaceClos").checked,
                    Secourisme: $("Secourisme").checked,
                    Nacelle: $("Nacelle").checked,
                    ProtectionRespiratoire: $("ProtectionRespiratoire").checked,
                    SIMDUT: $("SIMDUT").checked,
                    Plateforme: $("Plateforme").checked,
                    Autres: $("Autres").checked,
                },
                
                engagement: $("Engagement").checked, 

                // Valeurs des champs du bas du formulaire (mis à jour par les listeners)
                travailleurNomFinal: $("TravailleurNomFinal").value,
                dateFinale: $("DateFinale").value,
                signatureData: getSignatureData(),
            };

            localStorage.setItem('lastTravailleurName', values.nomTravailleur);
            return values;
        }

        // === Signature / Canvas (Pointer Events + DPI clean) ===
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');

        let drawing = false;
        let dpr = 1;

        function resizeCanvas() {
          dpr = window.devicePixelRatio || 1;
          const rect = canvas.getBoundingClientRect();

          // Taille bitmap en device pixels
          canvas.width = Math.max(1, Math.floor(rect.width * dpr));
          canvas.height = Math.max(1, Math.floor(rect.height * dpr));

          // Espace utilisateur = CSS pixels
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.scale(dpr, dpr);
        
          // Fond en unités CSS (puisque le contexte est déjà scalé)
          ctx.clearRect(0, 0, rect.width, rect.height);
          ctx.fillStyle = "#f8fafc";
          ctx.fillRect(0, 0, rect.width, rect.height);
        
          ctx.strokeStyle = "#000";
          ctx.lineWidth = 2;
          ctx.lineCap = 'round';
        }

        function getXY(e) {
          const rect = canvas.getBoundingClientRect();
          return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
          };
        }
        
        function startDrawing(e) {
          e.preventDefault();
          canvas.setPointerCapture?.(e.pointerId);
          drawing = true;
          ctx.beginPath();
          const { x, y } = getXY(e);
          ctx.moveTo(x, y);
        }
        
        function draw(e) {
          if (!drawing) return;
          e.preventDefault();
          const { x, y } = getXY(e);
          // Option stylet: pression disponible (0..1)
          // ctx.lineWidth = 1 + 3 * (e.pressure || 0);
          ctx.lineTo(x, y);
          ctx.stroke();
        }

        function stopDrawing(e) {
          if (!drawing) return;
          drawing = false;
          try { canvas.releasePointerCapture?.(e.pointerId); } catch {}
        }
        
        window.addEventListener('load', resizeCanvas, { passive: true });
        window.addEventListener('resize', resizeCanvas, { passive: true });
        
        // Un seul set d'événements pour souris/tactile/stylet
        canvas.addEventListener('pointerdown', startDrawing, { passive: false });
        canvas.addEventListener('pointermove', draw, { passive: false });
        canvas.addEventListener('pointerup', stopDrawing, { passive: false });
        canvas.addEventListener('pointercancel', stopDrawing, { passive: false });
        canvas.addEventListener('pointerleave', stopDrawing, { passive: false });
        
        // Effacer
        document.getElementById('clearSignature').addEventListener('click', () => {
          const rect = canvas.getBoundingClientRect();
          ctx.clearRect(0, 0, rect.width, rect.height);
          ctx.fillStyle = "#f8fafc";
          ctx.fillRect(0, 0, rect.width, rect.height);
        });

        function getSignatureData() {
          // Canvas d'export plus petit
          const exportCanvas = document.createElement('canvas');
          exportCanvas.width = 300;   // au lieu de 400
          exportCanvas.height = 75;   // au lieu de 100
          const exCtx = exportCanvas.getContext('2d');
        
          // Fond BLANC (meilleure compression JPEG)
          exCtx.fillStyle = "#ffffff";
          exCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
        
          // Ré-échantillonne la signature
          exCtx.drawImage(canvas, 0, 0, exportCanvas.width, exportCanvas.height);
        
          // JPEG qualité 0.6 (réglable 0.5–0.8)
          return exportCanvas.toDataURL('image/jpeg', 0.6);
        }

        // Pré-remplir la date du jour pour "DateDuJour" et copier dans "DateFinale"
        window.addEventListener('load', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            const dateDuJourInput = document.getElementById('DateDuJour');
            dateDuJourInput.value = formattedDate;
            dateDuJourInput.dispatchEvent(new Event('input'));

            resizeCanvas(); 

            const nomTravailleurInput = document.getElementById('NomTravailleur');
            const lastTravailleurName = localStorage.getItem('lastTravailleurName');
            if (lastTravailleurName) {
                nomTravailleurInput.value = lastTravailleurName;
                nomTravailleurInput.dispatchEvent(new Event('input'));
            }
        });

        // Synchronisation automatique des champs
        document.getElementById('NomTravailleur').addEventListener('input', (event) => {
            document.getElementById('TravailleurNomFinal').value = event.target.value.toUpperCase();
        });

        document.getElementById('DateDuJour').addEventListener('input', (event) => {
            document.getElementById('DateFinale').value = event.target.value;
        });

        // Fonction pour valider les cases à cocher de formation
        function validateFormations() {
            const checkboxes = document.querySelectorAll('#formationsCheckboxes input[type="checkbox"]');
            let isChecked = false;
            for (const checkbox of checkboxes) {
                if (checkbox.checked) {
                    isChecked = true;
                    break;
                }
            }
            return isChecked;
        }
        function arrayBufferToBase64(buffer) {
          let binary = '';
          const bytes = new Uint8Array(buffer);
          const chunk = 0x8000; // morceaux pour éviter les gros call stacks
          for (let i = 0; i < bytes.length; i += chunk) {
            binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
          }
          return btoa(binary);
        }

        // Fonction principale pour construire le PDF
        async function buildPdf({ flatten = false, preview = false, share = false } = {}) {
            const v = readFormValues(); 

            // Validation des champs obligatoires
            const formElement = document.getElementById('form');
            if (!formElement.checkValidity()) {
                alert("Veuillez remplir tous les champs obligatoires marqués d'un astérisque (*).");
                return;
            }
            // Validation spécifique pour la section des formations
            if (!validateFormations()) {
                alert("Veuillez sélectionner au moins une formation.");
                return;
            }
            // Validation spécifique pour la signature
            if (!v.signatureData) {
                alert("Veuillez dessiner votre signature avant de générer le PDF.");
                return; 
            }
            // Vérifie si le nom du travailleur est rempli en bas
            if (!v.travailleurNomFinal) {
                alert("Veuillez remplir le 'Prénom et Nom' en haut du formulaire.");
                return;
            }

            const pdf = await loadTemplate(); 
            const form = pdf.getForm(); 
            const pages = pdf.getPages(); 

            try {
                console.log('Champs détectés dans le PDF →');
                for (const f of form.getFields()) {
                    console.log('-', f.getName());
                }
            } catch(e) {
                console.error("Erreur lors de la lecture des champs PDF:", e);
            }

            // Remplissage des champs de texte
            setText(form, map.nomProjet, v.nomProjet);
            const dateDuJourValue = v.dateDuJour ? new Date(v.dateDuJour + 'T12:00:00') : null;
            const dateDuJourStr = dateDuJourValue ? `${String(dateDuJourValue.getDate()).padStart(2,'0')}/${String(dateDuJourValue.getMonth()+1).padStart(2,'0')}/${dateDuJourValue.getFullYear()}` : '';
            setText(form, map.dateDuJour, dateDuJourStr); 
            setText(form, map.metierCCQ, v.metierCCQ);
            const d = v.echeanceCCQ ? new Date(v.echeanceCCQ + 'T12:00:00') : null;
            const dStr = d ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` : '';
            setText(form, map.echeanceCCQ, dStr);
            setText(form, map.nomTravailleur, v.nomTravailleur);
            setText(form, map.entreprise, v.entreprise);
            setText(form, map.tel1, v.tel1);
            setText(form, map.tel3, v.tel3);
            setText(form, map.contactUrgence, v.contactUrgence);

            // Remplissage des sélecteurs Oui/Non (qui sont des groupes radio dans le PDF)
            setRadio(form, map.rss, v.rss ? 'Oui' : 'Non');
            setRadio(form, map.sante_pb, v.santePb ? 'Oui' : 'Non');
            setText(form, map.sante_details, v.santeDetails);

            // Remplissage des cases à cocher pour les formations
            for (const key of Object.keys(v.formations)) {
                setCheck(form, map[key] || [key], !!v.formations[key]);
            }
            
            // Remplissage de la case à cocher d'engagement
            setCheck(form, map.Engagement, v.engagement);

            // Remplissage des champs du bas
            setText(form, map.travailleurNomFinal, v.travailleurNomFinal);
            const dateFinaleValue = v.dateFinale ? new Date(v.dateFinale + 'T12:00:00') : null;
            const dateFinaleStr = dateFinaleValue ? `${String(dateFinaleValue.getDate()).padStart(2,'0')}/${String(dateFinaleValue.getMonth()+1).padStart(2,'0')}/${dateFinaleValue.getFullYear()}` : '';
            setText(form, map.dateFinale, dateFinaleStr); 

            // GESTION DE LA SIGNATURE DESSINÉE
            try {
              const signatureImage = await pdf.embedJpg(v.signatureData);
              const lastPage = pages[pages.length - 1];
            
              // Position dans le PDF (en points). Garde tes mm*2.835 si tu veux.
              const signatureX = 82 * 2.835;
              const signatureY = 39 * 2.835;
            
              // Boîte MAX pour la signature (ajuste à ton champ PDF)
              const maxWidthPt  = 164.4; // ≈ 58 mm
              const maxHeightPt = 21;  // ≈ 8 mm
            
              // Dimensions natives de l'image (issues du PNG normalisé 400x100 → ratio 4:1)
              const imgW = signatureImage.width;
              const imgH = signatureImage.height;
              const ratio = imgW / imgH;
            
              // Fit dans la boîte max en conservant le ratio
              let targetW = maxWidthPt;
              let targetH = targetW / ratio;
              if (targetH > maxHeightPt) {
                targetH = maxHeightPt;
                targetW = targetH * ratio;
              }
            
              lastPage.drawImage(signatureImage, {
                x: signatureX,
                y: signatureY,
                width: targetW,
                height: targetH,
              });
            } catch (error) {
              console.error("Erreur lors de l'intégration de la signature :", error);
              alert("La signature n'a pas pu être intégrée au PDF. Réessayez.");
            }

            // Si "flatten" est vrai, les champs du formulaire sont fusionnés avec le document
            if (flatten) form.flatten();
            const bytes = await pdf.save(); 
            const filename = `Formulaire_PRD_${v.nomTravailleur.replace(/\s+/g, '_') || 'sans_nom'}_${Date.now()}.pdf`;
            const file = new File([bytes], filename, { type:'application/pdf' });

            // Téléchargement ou aperçu
            if (preview) {
                const blobUrl = URL.createObjectURL(file);
                window.open(blobUrl, '_blank');
            } else if (share && navigator.share) {
                try {
                    await navigator.share({
                        title: filename,
                        files: [file],
                    });
                } catch (error) {
                    console.error('Erreur de partage:', error);
                    alert('Le partage a échoué. Assurez-vous que votre appareil prend en charge le partage de fichiers.');
                }
            } else {
                const url = URL.createObjectURL(file);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        async function generatePdfBytesForEmail() {
          const v = readFormValues();
        
          // mêmes validations que buildPdf
          const formElement = document.getElementById('form');
          if (!formElement.checkValidity()) throw new Error("Veuillez remplir tous les champs obligatoires marqués d'un astérisque (*).");
          if (!validateFormations()) throw new Error("Veuillez sélectionner au moins une formation.");
          if (!v.signatureData) throw new Error("Veuillez dessiner votre signature avant de générer le PDF.");
          if (!v.travailleurNomFinal) throw new Error("Veuillez remplir le 'Prénom et Nom' en haut du formulaire.");
        
          const pdf = await loadTemplate();
          const form = pdf.getForm();
          const pages = pdf.getPages();
        
          // ——— Remplissages identiques à buildPdf ———
          setText(form, map.nomProjet, v.nomProjet);
          const dateDuJourValue = v.dateDuJour ? new Date(v.dateDuJour + 'T12:00:00') : null;
          const dateDuJourStr = dateDuJourValue ? `${String(dateDuJourValue.getDate()).padStart(2,'0')}/${String(dateDuJourValue.getMonth()+1).padStart(2,'0')}/${dateDuJourValue.getFullYear()}` : '';
          setText(form, map.dateDuJour, dateDuJourStr); 
          setText(form, map.metierCCQ, v.metierCCQ);
          const d = v.echeanceCCQ ? new Date(v.echeanceCCQ + 'T12:00:00') : null;
          const dStr = d ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` : '';
          setText(form, map.echeanceCCQ, dStr);
          setText(form, map.nomTravailleur, v.nomTravailleur);
          setText(form, map.entreprise, v.entreprise);
          setText(form, map.tel1, v.tel1);
          setText(form, map.tel3, v.tel3);
          setText(form, map.contactUrgence, v.contactUrgence);
        
          setRadio(form, map.rss, v.rss ? 'Oui' : 'Non');
          setRadio(form, map.sante_pb, v.santePb ? 'Oui' : 'Non');
          setText(form, map.sante_details, v.santeDetails);
        
          for (const key of Object.keys(v.formations)) {
            setCheck(form, map[key] || [key], !!v.formations[key]);
          }
          setCheck(form, map.Engagement, v.engagement);
        
          setText(form, map.travailleurNomFinal, v.travailleurNomFinal);
          const dateFinaleValue = v.dateFinale ? new Date(v.dateFinale + 'T12:00:00') : null;
          const dateFinaleStr = dateFinaleValue ? `${String(dateFinaleValue.getDate()).padStart(2,'0')}/${String(dateFinaleValue.getMonth()+1).padStart(2,'0')}/${dateFinaleValue.getFullYear()}` : '';
          setText(form, map.dateFinale, dateFinaleStr);
        
          // ——— Signature (fit dans 58 x 8 mm) ———
          try {
            const signatureImage = await pdf.embedJpg(v.signatureData);
            const lastPage = pages[pages.length - 1];
        
            const signatureX = 82 * 2.835;
            const signatureY = 39 * 2.835;
        
            const maxWidthPt  = 164.4; // 58 mm
            const maxHeightPt = 22.7;  // 8 mm  (pas 21)
        
            const imgW = signatureImage.width;
            const imgH = signatureImage.height;
            const ratio = imgW / imgH;
        
            let targetW = maxWidthPt;
            let targetH = targetW / ratio;
            if (targetH > maxHeightPt) {
              targetH = maxHeightPt;
              targetW = targetH * ratio;
            }
        
            lastPage.drawImage(signatureImage, {
              x: signatureX,
              y: signatureY,
              width: targetW,
              height: targetH,
            });
          } catch (e) {
            throw new Error("La signature n'a pas pu être intégrée au PDF.");
          }
        
          // Optionnel : figer les champs pour l'email
          // form.flatten();
        
          const bytes = await pdf.save(); // Uint8Array
          const base64 = arrayBufferToBase64(bytes);
          const safeName = (v.nomTravailleur || 'sans_nom').replace(/\s+/g, '_');
          const filename = `Formulaire_PRD_${safeName}.pdf`;
        
          return { base64, filename };
        }

        document.getElementById('btnEmail')?.addEventListener('click', async () => {
          try {
            const { base64, filename } = await generatePdfBytesForEmail();
        
            const r = await fetch('/api/send', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                to: 'jerome.pouillard74@gmail.com', 
                subject: 'Accueil Chantier – Formulaire PDF',
                html: '<p>Veuillez trouver le PDF en pièce jointe.</p>',
                filename,
                pdfBase64: base64
              })
            });
        
            const data = await r.json();
            if (!r.ok || !data.ok) {
              console.error('Échec envoi:', data);
              alert('❌ Envoi échoué. Regarde la console et les logs Vercel/Resend.');
              return;
            }
            alert('✅ PDF envoyé par courriel !');
          } catch (err) {
            console.error(err);
            alert('❌ ' + (err?.message || err));
          }
        });
    

        // Ajout des écouteurs d'événements aux boutons
        document.getElementById('btnGen').addEventListener('click', () => buildPdf({ flatten: false }));
        document.getElementById('btnGenFlatten').addEventListener('click', () => buildPdf({ flatten: true }));
        document.getElementById('btnPreview').addEventListener('click', () => buildPdf({ preview: true }));
        document.getElementById('btnShare').addEventListener('click', () => buildPdf({ share: true }));
    </script>
</body>
</html>
