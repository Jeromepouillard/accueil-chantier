<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Accueil Chantier – Remplissage PDF (100% gratuit)</title>
    <style>
        /* Styles généraux pour l'ensemble du corps du document */
        :root { --brand:#0f172a; --accent:#0ea5e9; --muted:#e5e7eb; }
        * { box-sizing:border-box }
        html { height:100%; } /* S'assurer que html prend toute la hauteur */
        body{
            min-height:100vh; /* S'assurer que body prend au moins toute la hauteur du viewport */
            margin:0;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            background:#fff;
            padding:24px; /* Garder le padding autour de la carte */
            color:var(--brand);
            overflow-y: auto; /* Permettre le défilement vertical si le contenu dépasse */
            display: block; /* Assurer que body se comporte comme un bloc */
        }
        
        /* Styles de la carte principale qui contient le formulaire */
        .card{
            width:100%;
            max-width:900px;
            background:#fff;
            border:1px solid var(--muted);
            border-radius:16px;
            padding:24px;
            box-shadow:0 10px 30px rgba(2,8,23,.06);
            /* Min-height pour s'assurer qu'elle prend de la place, même avec peu de contenu */
            min-height: 200px; 
            margin: 0 auto; /* Centre la carte horizontalement */
        }
        
        /* Styles de l'en-tête de la carte (logo et titre) */
        header { 
            display: flex; 
            flex-direction: column; /* Empile les éléments (logo et div de texte) verticalement */
            align-items: center; /* Centre les éléments horizontalement dans l'en-tête */
            gap: 8px; /* Réduit l'espace entre le logo et le texte */
            margin-bottom: 12px; 
            text-align: center; /* Centre le texte à l'intérieur du div si nécessaire */
        }
        header img{height:40px} /* Hauteur fixe pour le logo */
        h1{font-size:clamp(20px,3.8vw,28px);margin:8px 0}
        
        /* Styles pour la disposition des éléments de formulaire en grille */
        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
        
        /* Styles des étiquettes de formulaire */
        label{font-weight:600;font-size:14px}
        
        /* Styles des champs de saisie, textarea et select */
        input,textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
        
        /* Styles pour les lignes (par ex. pour les sélecteurs Oui/Non) */
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        
        /* Styles pour les groupes de cases à cocher */
        .checkboxes{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px}
        
        /* Styles pour les sections du formulaire */
        .section{border-top:1px solid var(--muted);margin-top:16px;padding-top:16px}
        
        /* Styles du conteneur des boutons d'action */
        .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
        
        /* Styles des boutons */
        button{appearance:none;border:1px solid #cbd5e1;background:#f8fafc;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer}
        button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
        button:active{transform:translateY(1px)}
        
        /* Styles pour le texte "muted" (petits messages d'information) */
        small.muted{display:block;margin-top:6px;color:#64748b}
        
        /* Styles pour les éléments alignés en ligne (par ex. label + select) */
        .inline{display:flex;align-items:center;gap:10px}
    </style>
</head>
<body>
    <main class="card">
        <header>
            <img src="assets/logo-prdesjardins.png" alt="P+R Desjardins"/>
            <div>
                <h1>Accueil des travailleurs — Générateur PDF éditable</h1>
                <small class="muted">
                    Place le PDF modèle à <code>/assets/accueil_travailleurs.pdf</code> (ton original renommé).
                    Rien à payer, tout dans le navigateur.
                </small>
            </div>
        </header>

        <form id="form" onsubmit="return false;">
            <!-- Section Informations du projet -->
            <div class="grid">
                <div>
                    <label for="NomProjet">Nom du projet</label>
                    <input id="NomProjet" placeholder="Ex: Tour XYZ" />
                </div>
                <div>
                    <label for="NumProjet"># Projet</label>
                    <input id="NumProjet" placeholder="Ex: 12345" /> <!-- Placeholder modifié -->
                </div>
                <div>
                    <label for="MetierCCQ">Métier CCQ</label>
                    <input id="MetierCCQ" />
                </div>
                <div>
                    <label for="EcheanceCCQ">Échéance carte CCQ</label>
                    <input id="EcheanceCCQ" type="date" />
                </div>
                <div>
                    <label for="NomTravailleur">Prénom et Nom</label>
                    <input id="NomTravailleur" />
                </div>
                <div>
                    <label for="Entreprise">Entreprise</label>
                    <input id="Entreprise" />
                </div>
                <div>
                    <label for="Telephone">Téléphone (principal)</label> <!-- Libellé modifié -->
                    <input id="Telephone" type="tel" />
                </div>
                <div>
                    <label for="Telephone2">Téléphone (secondaire)</label> <!-- Libellé modifié -->
                    <input id="Telephone2" type="tel" />
                </div>
                <div>
                    <label for="Telephone3">Téléphone (contact d'urgence)</label> <!-- Libellé modifié -->
                    <input id="Telephone3" type="tel" />
                </div>
                <div>
                    <label for="ContactUrgence">Nom du contact d'urgence</label> <!-- Libellé modifié -->
                    <input id="ContactUrgence" />
                </div>
            </div>

            <!-- Section RSS et Problème de santé -->
            <div class="section">
                <div class="row">
                    <div class="inline">
                        <label for="Rss">Êtes‑vous intéressé à être RSS ?</label>
                        <select id="Rss"><option value="Non">Non</option><option value="Oui">Oui</option></select>
                    </div>
                    <div class="inline">
                        <label for="SantePb">Problème de santé ?</label>
                        <select id="SantePb"><option value="Non">Non</option><option value="Oui">Oui</option></select>
                    </div>
                </div>
                <label for="SanteDetails">Précisez (si Oui)</label>
                <textarea id="SanteDetails" rows="2" placeholder="Asthme, allergie, etc."></textarea>
            </div>

            <!-- Section Formations du travailleur -->
            <div class="section">
                <h3>FORMATIONS DU TRAVAILLEUR</h3>
                <div class="checkboxes">
                    <label><input type="checkbox" id="Cadenassage"> Cadenassage</label>
                    <label><input type="checkbox" id="Amiante"> Amiante / silice</label>
                    <label><input type="checkbox" id="EspaceClos"> Espace clos</label>
                    <label><input type="checkbox" id="Secourisme"> Secourisme en milieu de travail</label>
                    <label><input type="checkbox" id="Nacelle"> Nacelle</label>
                    <label><input type="checkbox" id="ProtectionRespiratoire"> Protection respiratoire (Fit Test 2 ans)</label>
                    <label><input type="checkbox" id="SIMDUT"> SIMDUT 2015 obligatoire</label>
                    <label><input type="checkbox" id="Plateforme"> Plateforme élévatrice</label>
                    <label><input type="checkbox" id="Autres"> Autres</label>
                </div>
            </div>

            <!-- Section Sujets traités (accueil) -->
            <div class="section">
                <h3>Sujets traités (accueil)</h3>
                <div class="checkboxes">
                    <label><input type="checkbox" id="RisquesGeneraux"> Risques généraux</label>
                    <label><input type="checkbox" id="RisquesSpecifiques"> Risques spécifiques au chantier</label>
                    <label><input type="checkbox" id="Evacuation"> Procédure d'évacuation / Rassemblement</label>
                    <label><input type="checkbox" id="Accident"> Procédure en cas d'accident</label>
                    <label><input type="checkbox" id="Politiques"> Politiques alcool, drogues, harcèlement, violence</label>
                    <label><input type="checkbox" id="ToleranceZero"> Tolérance zéro</label>
                    <label><input type="checkbox" id="DroitsObligations"> Droits et obligations</label>
                    <label><input type="checkbox" id="EPI"> EPI</label>
                </div>
            </div>

            <!-- Section Engagement du travailleur -->
            <div class="section">
                <div class="inline">
                    <input type="checkbox" id="Engagement" />
                    <label for="Engagement">J'ai pris connaissance du programme de prévention, tolérances zéro, etc.</label>
                </div>
            </div>

            <!-- Boutons d'action pour le PDF -->
            <div class="btns">
                <button class="primary" id="btnGen">Générer le PDF (éditable)</button>
                <button id="btnGenFlatten">Générer (aplati pour impression)</button>
                <button id="btnPreview">Prévisualiser dans le navigateur</button>
                <button id="btnShare">Partager (mobile)</button>
            </div>
            <small class="muted">
                Astuce: ouvre la console F12 pour voir la liste exacte des noms de champs détectés dans le PDF (utile si certains noms varient).
            </small>
        </form>
    </main>

    <!-- Importation de la bibliothèque pdf-lib pour la manipulation de PDF -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // Utilitaires pour gérer les noms de champs PDF qui peuvent varier
        // Permet de trouver un champ par plusieurs noms possibles
        function getFieldByNames(form, names) {
            for (const n of names) {
                try { return form.getField(n); } catch(e) {}
            }
            return null; // Retourne null si aucun champ n'est trouvé avec les noms donnés
        }

        // Définit le texte d'un champ PDF
        function setText(form, names, value) {
            const f = getFieldByNames(form, names);
            if (f && f.setText) { f.setText(value ?? ''); } // Utilise la valeur ou une chaîne vide
        }

        // Coche ou décoche une case à cocher dans le PDF
        function setCheck(form, names, checked) {
            const f = getFieldByNames(form, names);
            if (!f) return; // Ne fait rien si le champ n'est pas trouvé
            try { checked ? f.check?.() : f.uncheck?.(); } catch(e) { /* Gère silencieusement les erreurs */ }
        }

        // Mapping des IDs des éléments HTML avec les noms des champs PDF
        // Cela permet de connecter facilement le formulaire HTML au PDF
        const map = {
            // En-tête du formulaire
            nomProjet: ["NomProjet","Nom du projet","Nom Projet"],
            // REMARQUE: "# Projet" est maintenant séparé de "# ACCUEIL"
            numProjet: ["Num Projet","# Projet","NumProjet"], 
            metierCCQ: ["Métier CCQ","Metier CCQ"],
            echeanceCCQ: ["Échéance Carte CCQ","Echéance Carte CCQ","Échéance carte CCQ"],

            // Coordonnées du travailleur
            nomTravailleur: ["NomTravailleur","Travailleur Prénom et Nom en lettres moulées","Prénom et Nom"],
            entreprise: ["Entreprise"],
            // Téléphones: les noms dans le PDF peuvent différer légèrement
            tel1: ["Téléphone","Telephone"],
            tel2: ["Téléphone_2","Telephone_2"],
            tel3: ["Téléphone_3","Telephone_3"],
            contactUrgence: ["Contact durgence","Contact d'urgence","Contact urgence"], // Le nom du contact d'urgence

            // Choix Oui/Non (stockés en texte dans le PDF original)
            rss: ["Rss"],
            sante_pb: ["sante_pb"],
            sante_details: ["Santé_es_:sender:", "SANTÉ", "Sante_details", "Santé - précisez"],

            // Formations (cases à cocher)
            Cadenassage: ["Cadenassage"],
            Amiante: ["Amiante","Amiante /silice","Amiante / silice"],
            EspaceClos: ["Espace clos"],
            Secourisme: ["Secourisme en milieu de travail"],
            Nacelle: ["Nacelle"],
            ProtectionRespiratoire: ["Protection respiratoire","Protection respiratoire   Fit Test 2ans"],
            SIMDUT: ["SIMDUT 2015 obligatoire","SIMDUT"],
            Plateforme: ["Plateforme élévatrice"],
            Autres: ["Autres"],

            // Sujets traités (cases à cocher)
            RisquesGeneraux: ["Risque généraux","Risques généraux"],
            RisquesSpecifiques: ["Risques spécifique","Risques spécifiques au chantier"],
            Evacuation: ["Procédure d'évacuation","Procédure d'évacuation / Rassemblement"],
            Accident: ["Procédure en cas d'accident","Prodécure en cas d'accident (trousses, déclaration événement accidentel, formulaire assignation temporaire)"],
            Politiques: ["Politiques drogues et alcools","Politiques alcool, drogues, harcèlement et violence"],
            ToleranceZero: ["Tolérence zéro","Tolérances Zéro","Tolérance Zéro"],
            DroitsObligations: ["Droits et obligations"],
            EPI: ["EPI"],

            // Engagement du travailleur (case à cocher)
            Engagement: ["Case à cocher24","ENGAGEMENT DU TRAVAILLEUR","Engagement"],

            // Champs de signature et de date dans le PDF
            signature: ["Signature26_es_:signer:signature:"],
            date1: ["Date27_es_:signer:date:","Date"],
            date2: ["Date29_es_:signer:date:"]
        };

        // Charge le modèle PDF à partir de l'URL spécifiée
        async function loadTemplate() {
            // Assurez-vous que votre PDF est bien nommé 'accueil_travailleurs.pdf'
            // et placé dans le dossier 'assets/' de votre projet GitHub.
            const url = 'assets/accueil_travailleurs.pdf'; 
            const buf = await fetch(url).then(r => {
                if (!r.ok) throw new Error('PDF modèle introuvable à ' + url);
                return r.arrayBuffer();
            });
            return PDFLib.PDFDocument.load(buf);
        }

        // Lit les valeurs du formulaire HTML
        function readFormValues() {
            const $ = id => document.getElementById(id);
            const values = {
                nomProjet: $("NomProjet").value,
                numProjet: $("NumProjet").value, // Récupère seulement le numéro de projet
                metierCCQ: $("MetierCCQ").value,
                echeanceCCQ: $("EcheanceCCQ").value, // Format YYYY-MM-DD
                nomTravailleur: $("NomTravailleur").value,
                entreprise: $("Entreprise").value,
                tel1: $("Telephone").value,
                tel2: $("Telephone2").value,
                tel3: $("Telephone3").value,
                contactUrgence: $("ContactUrgence").value,
                rss: $("Rss").value === 'Oui', // Convertit "Oui" en true, "Non" en false
                santePb: $("SantePb").value === 'Oui',
                santeDetails: $("SanteDetails").value,
                
                // Collecte l'état des cases à cocher de formation
                formations: {
                    Cadenassage: $("Cadenassage").checked,
                    Amiante: $("Amiante").checked,
                    EspaceClos: $("EspaceClos").checked,
                    Secourisme: $("Secourisme").checked,
                    Nacelle: $("Nacelle").checked,
                    ProtectionRespiratoire: $("ProtectionRespiratoire").checked,
                    SIMDUT: $("SIMDUT").checked,
                    Plateforme: $("Plateforme").checked,
                    Autres: $("Autres").checked,
                },
                // Collecte l'état des cases à cocher des sujets traités
                sujets: {
                    RisquesGeneraux: $("RisquesGeneraux").checked,
                    RisquesSpecifiques: $("RisquesSpecifiques").checked,
                    Evacuation: $("Evacuation").checked,
                    Accident: $("Accident").checked,
                    Politiques: $("Politiques").checked,
                    ToleranceZero: $("ToleranceZero").checked,
                    DroitsObligations: $("DroitsObligations").checked,
                    EPI: $("EPI").checked,
                },
                // Collecte l'état de la case à cocher d'engagement
                engagement: $("Engagement").checked,
            };

            // Sauvegarde le nom du travailleur dans localStorage pour la page d'accueil
            localStorage.setItem('lastTravailleurName', values.nomTravailleur);
            return values;
        }

        // Fonction principale pour construire le PDF
        async function buildPdf({ flatten = false, preview = false, share = false } = {}) {
            const pdf = await loadTemplate(); // Charge le PDF modèle
            const form = pdf.getForm(); // Accède aux champs du formulaire PDF

            // Debug : Affiche la liste des noms de champs détectés dans le PDF (pour débugger le mapping)
            try {
                console.log('Champs détectés dans le PDF →');
                for (const f of form.getFields()) {
                    console.log('-', f.getName());
                }
            } catch(e) {
                console.error("Erreur lors de la lecture des champs PDF:", e);
            }

            const v = readFormValues(); // Récupère les valeurs du formulaire HTML

            // Remplissage des champs de texte
            setText(form, map.nomProjet, v.nomProjet);
            setText(form, map.numProjet, v.numProjet); // Utilise seulement le numéro de projet
            setText(form, map.metierCCQ, v.metierCCQ);
            
            // Conversion de la date (YYYY-MM-DD en DD/MM/YYYY)
            const d = v.echeanceCCQ ? new Date(v.echeanceCCQ) : null;
            const dStr = d ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}` : '';
            setText(form, map.echeanceCCQ, dStr);

            setText(form, map.nomTravailleur, v.nomTravailleur);
            setText(form, map.entreprise, v.entreprise);
            setText(form, map.tel1, v.tel1);
            setText(form, map.tel2, v.tel2);
            setText(form, map.tel3, v.tel3);
            setText(form, map.contactUrgence, v.contactUrgence);

            // Remplissage des sélecteurs Oui/Non (qui sont des champs de texte dans le PDF)
            setText(form, map.rss, v.rss ? 'Oui' : 'Non');
            setText(form, map.sante_pb, v.santePb ? 'Oui' : 'Non');
            setText(form, map.sante_details, v.santeDetails);

            // Remplissage des cases à cocher pour les formations
            for (const key of Object.keys(v.formations)) {
                setCheck(form, map[key] || [key], !!v.formations[key]);
            }

            // Remplissage des cases à cocher pour les sujets traités
            for (const key of Object.keys(v.sujets)) {
                setCheck(form, map[key] || [key], !!v.sujets[key]);
            }

            // Remplissage de la case à cocher d'engagement
            setCheck(form, map.Engagement, v.engagement);

            // Remplissage des dates de signature (avec la date du jour)
            const today = new Date();
            const todayStr = `${String(today.getDate()).padStart(2,'0')}/${String(today.getMonth()+1).padStart(2,'0')}/${today.getFullYear()}`;
            setText(form, map.date1, todayStr);
            setText(form, map.date2, todayStr);

            // Si "flatten" est vrai, les champs du formulaire sont fusionnés avec le document
            // Cela les rend non éditables une fois le PDF généré
            if (flatten) form.flatten();

            const bytes = await pdf.save(); // Sauvegarde le PDF modifié
            const filename = `Formulaire_PRD_${v.nomTravailleur.replace(/\s+/g, '_') || 'sans_nom'}_${Date.now()}.pdf`;
            const file = new File([bytes], filename, { type:'application/pdf' });

            // Sauvegarde le PDF généré en base64 dans le localStorage
            // pour que la page principale puisse potentiellement y faire référence
            localStorage.setItem('generatedPdf', URL.createObjectURL(file)); // Stocke l'URL de l'objet Blob
            localStorage.setItem('generatedPdfFileName', filename); // Stocke le nom du fichier

            // Option de partage (Web Share API, idéal pour mobile)
            if (share && navigator.canShare?.({ files:[file] })) {
                try { 
                    await navigator.share({ files:[file], title:'Formulaire PRD', text:'Voici votre formulaire PRD rempli.' }); 
                    return; 
                } catch(e) { 
                    console.error("Erreur de partage:", e);
                    // L'utilisateur a probablement annulé le partage
                }
            }

            // Option de prévisualisation dans une nouvelle fenêtre/onglet
            if (preview) {
                const url = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
                window.open(url, '_blank');
                return;
            }

            // Téléchargement par défaut si les autres options ne sont pas utilisées
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([bytes], { type:'application/pdf' }));
            a.download = file.name;
            document.body.appendChild(a); 
            a.click(); 
            a.remove();
        }

        // Événements des boutons
        document.getElementById('btnGen').addEventListener('click', () => buildPdf({ flatten:false }));
        document.getElementById('btnGenFlatten').addEventListener('click', () => buildPdf({ flatten:true }));
        document.getElementById('btnPreview').addEventListener('click', () => buildPdf({ preview:true }));
        document.getElementById('btnShare').addEventListener('click', () => buildPdf({ share:true }));
    </script>
</body>
</html>
